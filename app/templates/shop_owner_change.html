{% extends 'layout/base.html' %}

{% block content %}
    <div class="content-area">
        <!-- 顶部操作栏 -->
        <div class="d-flex align-items-center flex-wrap mb-3">
            <!-- 操作按钮 -->
            <a href="{{ url_for('main.add_shop_owner_change') }}" class="btn btn-primary me-2 mb-2">申请更换店主</a>
            <!-- 查询表单 -->
            <form action="{{ url_for('main.shop_owner_change') }}" method="get" class="d-flex align-items-center mb-2 flex-grow-0">
                <select class="form-select me-2" name="status" id="status">
                    <option value="">所有状态</option>
                    <option value="1" {% if status_filter == '1' %}selected{% endif %}>待处理</option>
                    <option value="2" {% if status_filter == '2' %}selected{% endif %}>已完成</option>
                    <option value="3" {% if status_filter == '3' %}selected{% endif %}>已拒绝</option>
                </select>
                <input type="text" class="input-group-text me-2" name="company_id" placeholder="输入公司ID" value="{{ request.args.get('company_id', '') }}">
                <button type="submit" class="btn btn-outline-primary">查询</button>
            </form>
             <div class="text-danger">有公司店主需要更换，可申请此表</div>
        </div>
        <table class="table table-striped table-bordered table-light table-hover">
            <thead>
            <tr>
                <th>公司ID</th>
                <th>申请事项</th>
                <th>新店主</th>
                <th>状态</th>
                <th>创建人</th>
                <th>创建时间</th>
                <th>处理人</th>
                <th>处理时间</th>
                <th>处理意见</th>
                <th>备注</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            {% for result  in results %}
                <tr style="">
                    <td>
                         <a href="https://www.bypms.cn/admin/user/fakelogin?companyId={{ result.company_id }}" target="_blank">
                                {{ result.company_id }}
                            </a>
                    </td>
                    <td style="max-width: 150px;">
                        <span class="wrap-ellipsis" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ result.content }}">{{ result.content }}</span>
                    </td>
                    <td style="max-width: 50px;">{% if result.new_owner %}{{ result.new_owner }}{% else %}{{ "" }}{% endif %}</td>
                    <td style="max-width: 70px;">
                        {% if result.status == 1 %}
                            <span class="status-pending">待处理</span>
                        {% elif result.status == 2 %}
                            已完成
                        {% elif result.status == 3 %}
                            已拒绝
{#                        {% elif special.status == 4 %}#}
{#                            已提交books#}
{#                        {% elif special.status == 5 %}#}
{#                            books已沟通#}
{#                        {% elif special.status == 6 %}#}
{#                            已拒绝#}
                        {% else %}
                            未知状态
                        {% endif %}
                    </td>
                    <td style="max-width: 50px;">{{ result.create_user_name }}</td>
                    <td style="max-width: 100px;">{{ result.create_datetime }}</td>
                    <td style="max-width: 50px;">{{ result.todo_user_name }}</td>
                    {% if result.todo_datetime == None %}
                        <td></td>
                    {% else %}
                        <td style="max-width: 100px;">{{ result.todo_datetime }}</td>
                    {% endif %}
                    {#                    {% if discount.final_plan is none or discount.final_plan == '' %}#}
                    <td style="max-width: 150px;">
                        <span class="wrap-ellipsis" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ result.final_plan }}">{{ result.final_plan|default('', true) }}</span>
                    </td>
                    <td style="max-width: 150px;">
                        <span class="wrap-ellipsis" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ result.todo_remark }}">{{ result.todo_remark|default('', true) }}</span>
                    </td>
                    <td>
                        {% if result.status == 1 %}
                            {% if result.todo_account_id == session['user_id'] %}
                                <a href="{{ url_for('main.do_shop_owner_change', id=result.id) }}" class="text-link do_link">处理</a>
                                <form id="delForm" action="{{ url_for('main.del_shop_owner_change') }}" method="POST">
                                     <input type="hidden" name="shop_id" id="shop_id" value="">
                                </form>
                                <a href="#" id="shop_id" data-id="{{ result.id }}" data-company="{{ result.company_id }}" onclick="confirmDelete(event, this)" class="text-link del_link"
                                style="text-decoration: underline;">删除</a>
                            {% endif %}
                            <a href="{{ url_for('main.edit_shop_owner_change', id=result.id, company_id=request.args.get('company_id')) }}" class="text-link edit_link">编辑</a>
                        {% elif result.status == 2 or result.status == 3%}
                            {% if session['user_id']!=7 %}
                                <a href="{{ url_for('main.remark_shop_owner_change', id=result.id, company_id=request.args.get('company_id')) }}" class="text-link edit_link">查看</a>
                            {% endif %}
                            {% if result.todo_account_id == session['user_id'] %}

                                <a href="{{ url_for('main.remark_shop_owner_change', id=result.id, company_id=request.args.get('company_id')) }}" class="text-link edit_link">备注</a>

{#                                <a href="{{ url_for('main.do_vip_refund', id=result.id) }}" class="text-link">备注</a>#}
                            {% endif %}
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>

        <div class="modal fade" id="remarkModal" tabindex="-1" aria-labelledby="remarkModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">填写备注</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="remarkForm" method="post">
                    <div class="row mb-3">
                        <label for="company_id_display" class="col-sm-2 col-form-label">公司ID：</label>
                        <div class="col-sm-8 d-flex align-items-center">
                            <!-- 仅用于显示，不提交 -->
                            <div id="company_id_display" class="text-muted"></div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <label for="remark" class="col-2 col-form-label">备注：</label>
                        <div class="col-4">
                            <textarea class="form-control" id="remark" name="remark" style="height: 200px; width: 600px;"></textarea>
                        </div>
                    </div>
                    <!-- 隐藏字段：id -->
                    <input type="hidden" id="id" name="id">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="submit" form="remarkForm" class="btn btn-primary">保存</button>
            </div>
        </div>
    </div>
</div>




        <!-- 底部分页控件 -->
        <nav aria-label="Page navigation" class="d-flex justify-content-end pagination-container">
            <ul class="pagination pagination-sm">
                <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.vip_refund', page=page-1) }}">上一页</a>
                </li>
                {% for num in range(1, total_pages + 1) %}
                    <li class="page-item {% if num == page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('main.vip_refund', page=num) }}">{{ num }}</a>
                    </li>
                {% endfor %}
                <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.vip_refund', page=page+1) }}">下一页</a>
                </li>
            </ul>
        </nav>
    </div>
    <script>
        $(document).ready(function () {
            $('[data-bs-toggle="tooltip"]').tooltip();
        });
    </script>

            <script>
function confirmDelete(event, element) {
    event.preventDefault(); // 阻止默认的链接行为

    const resultId = element.getAttribute('data-id');
    const company_id = element.getAttribute('data-company');

    if (confirm(`确定要删除公司ID为 ${company_id}的记录吗？`)) {
        // 设置表单中的隐藏字段值
        document.getElementById('shop_id').value = resultId;
        // 提交表单
        document.getElementById('delForm').submit();
    }
}
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // 初始化模态对话框中的数据
    $('.remark-button').on('click', function () {
        var Id = $(this).data('id'); // 获取记录 ID
        var companyId = $(this).data('company'); // 获取公司 ID
        var remark = $(this).data('remark'); // 获取备注内容

        console.log('Id:', Id); // 调试信息
        console.log('companyId:', companyId); // 调试信息
        console.log('remark:', remark); // 调试信息

        // 填充模态框中的数据
        $('#id').val(Id); // 设置隐藏的 ID 字段
        $('#company_id_display').text(companyId || '暂无'); // 显示公司 ID
        $('#remark').val(remark || ''); // 显示备注内容（如果存在）
    });

    // 表单提交处理
    $('#remarkForm').on('submit', function (event) {
        event.preventDefault(); // 阻止表单默认提交行为

        // 获取表单数据
        var formData = $(this).serialize();

        console.log('Form Data:', formData); // 调试信息

        $.ajax({
            url: '/remark_shop_owner_change', // 替换为你的后端API地址
            type: 'POST',
            data: formData,
            success: function (response) {
                // 处理成功响应
                {#alert('数据提交成功');#}
                $('#remarkModal').modal('hide'); // 关闭模态对话框
                location.reload(); // 刷新页面或更新DOM
            },
            error: function (xhr, status, error) {
                // 处理错误响应
                console.error('数据提交失败:', xhr.responseText);
                alert('提交失败，请稍后再试！');
            }
        });
    });
});

</script>

    <style>
    .text-danger {
        color: #dc6a35; /* 或其他您希望的颜色 */
        margin-left: 15px; /* 添加左侧间距 */
    }

    .del_link, .edit_link ,.do_link{
            display: block;
            margin-bottom: 5px; /* 设置底部间距 */
        }


    </style>
{% endblock %}
