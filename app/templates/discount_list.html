{% extends 'layout/base.html' %}

{% block content %}
    <div class="content-area">
        <!-- 顶部操作栏 -->
        <div class="d-flex align-items-center flex-wrap mb-3">
            <!-- 操作按钮 -->
            <a href="{{ url_for('main.add_discount') }}" class="btn btn-primary me-2 mb-2">申请特殊优惠</a>
            <!-- 查询表单 -->
            <form action="{{ url_for('main.discounts') }}" method="get" class="d-flex align-items-center mb-2 flex-grow-0">
                <select class="form-select me-2" name="status" id="status">
                    <option value="">所有状态</option>

                    <option value="1" {% if status_filter == '1' %}selected{% endif %}>待处理</option>
                    <option value="2" {% if status_filter == '2' %}selected{% endif %}>已沟通</option>
                    <option value="4" {% if status_filter == '4' %}selected{% endif %}>已提交books</option>
                    <option value="5" {% if status_filter == '5' %}selected{% endif %}>books已沟通</option>
                    <option value="3" {% if status_filter == '3' %}selected{% endif %}>已完成</option>
                    <option value="6" {% if status_filter == '6' %}selected{% endif %}>已拒绝</option>
                    <option value="7" {% if status_filter == '7' %}selected{% endif %}>继续跟踪</option>
                    <option value="9" {% if status_filter == '9' %}selected{% endif %}>已放弃</option>
                </select>
                <input type="text" class="input-group-text me-2" name="company_id" placeholder="输入公司ID" value="{{ request.args.get('company_id', '') }}">
                <input type="text" class="input-group-text me-2" name="contact" placeholder="联系方式" value="{{ request.args.get('contact', '') }}">
                <button type="submit" class="btn btn-outline-primary">查询</button>
            </form>
        </div>
        <p class="record_custom-margin">
            待处理: {{ status1_count }}&emsp;&emsp;&emsp;
            已沟通: {{ status2_count }}&emsp;&emsp;&emsp;
            已提交books: {{ status4_count }}&emsp;&emsp;&emsp;
            books已沟通: {{ status5_count }}&emsp;&emsp;&emsp;
            继续跟踪: {{ status7_count }}&emsp;&emsp;&emsp;

            {#            <span style="color: red;">未认领：{{ unclaimed_count }}</span>&emsp;&emsp;&emsp;#}
            {#            待处理：{{ status1_count }}（初步沟通），{{ step_two_count }}（直连），{{ step_four_count }}（转售后），{{ step_six_count }}（放弃）#}
        </p>
        <table class="table table-striped table-bordered table-light table-hover">
            <thead>
            <tr>
                <th>公司ID</th>
                <th>房号数</th>
                <th>备注</th>
                <th>联系方式</th>
                <th>到期日</th>
                <th>状态</th>
                <th>创建人</th>
                <th>创建时间</th>
                <th>处理人</th>
                <th>处理时间</th>
                <th>优惠方案</th>
                <th>执行结果</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            {% for discount  in results %}
                <tr>
                    <td>
                        <a href="https://www.bypms.cn/admin/user/fakelogin?companyId={{ discount.company_id }}" target="_blank">
                            {{ discount.company_id }}
                        </a>
                    </td>
                    <td style="max-width: 50px;">{% if discount.room_count %}{{ discount.room_count }}{% else %}{{ "" }}{% endif %}</td>
                    <td style="max-width: 150px;">
                        <span class="wrap-ellipsis" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ discount.remark }}">{{ discount.remark }}</span>
                    </td>
                    <td style="max-width: 70px;">{% if discount.phone %}{{ discount.phone }}{% else %}{{ "" }}{% endif %}</td>
                    <td style="max-width: 70px;">{% if discount.end_data %}{{ discount.end_data }}{% else %}{{ "" }}{% endif %}</td>
                   <td style="max-width: 70px;" class="status-cell" data-id="{{ discount.id }}"
                        data-can-edit="{% if discount.todo_userid == session['user_id'] %}true{% else %}false{% endif %}">
                    <!-- Default status display -->
                    <span class="status-display">
                        {% if discount.status == 1 %}
                            <span class="status-pending">待处理</span>
                        {% elif discount.status == 2 %}
                            已沟通
                        {% elif discount.status == 3 %}
                            已完成
                        {% elif discount.status == 4 %}
                            已提交books
                        {% elif discount.status == 5 %}
                            books已沟通
                        {% elif discount.status == 6 %}
                            已拒绝
                        {% elif discount.status == 7 %}
                            <span style="color: #13653f;">继续跟踪</span>
                        {% elif discount.status == 9 %}
                            已放弃
                        {% else %}
                            未知状态
                        {% endif %}
                    </span>

                    <!-- Dropdown (hidden by default) -->
                    <select class="form-select status-select d-none">
                        <option value="1" {% if discount.status == 1 %}selected{% endif %}>待处理</option>
                        <option value="2" {% if discount.status == 2 %}selected{% endif %}>已沟通</option>
                    </select>
                    <div class="spinner-border spinner-border-sm text-primary d-none"></div>
                </td>
                    <td style="max-width: 50px;">{{ discount.create_user_name }}</td>
                    <td style="max-width: 100px;">{{ discount.create_datetime }}</td>
                    <td style="max-width: 50px;">{{ discount.todo_user_name }}</td>
                    {% if discount.todo_datetime == None %}
                        <td></td>
                    {% else %}
                        <td style="max-width: 100px;">{{ discount.todo_datetime }}</td>
                    {% endif %}
                    {#                    {% if discount.final_plan is none or discount.final_plan == '' %}#}
                    <td style="max-width: 150px;">
                        <span class="wrap-ellipsis" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ discount.details }}">{{ discount.details|default('', true) }}</span>
                    </td>
                    <td style="max-width: 150px;">
                        <span class="wrap-ellipsis" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ discount.final_plan }}">{{ discount.final_plan|default('', true) }}</span>
                    </td>
                    <td style="max-width: 80px;">


                        {% if discount.status == 1 or discount.status == 4 %}
                            {% if discount.status == 1 %}
                                <a href="{{ url_for('main.edit_discount', id=discount.id, status=status_filter, company_id=request.args.get('company_id')) }}" class="text-link edit_link">编辑</a>
                            {% endif %}
                            {% if discount.todo_userid == session['user_id'] %}
                                <a href="{{ url_for('main.do_discount', id=discount.id, status=status_filter, company_id=request.args.get('company_id')) }}" class="text-link do_link">处理</a>

                                <form id="delForm" action="{{ url_for('main.del_discount') }}" method="POST">
                                    <input type="hidden" name="discount_id" id="discount_id" value="">
                                </form>
                                <a href="#" id="del_discount" data-id="{{ discount.id }}" data-company="{{ discount.company_id }}" onclick="confirmDelete(event, this)" class="text-link del_link"
                                   style="text-decoration: underline;">删除</a>

                                <a
                                        href="{{ url_for('main.move_discount', id=discount.id,company_id=request.args.get('company_id'))}}"
                                        class="text-link edit_link"
                                        onclick="return confirm('确定要移动公司 ' + {{ discount.company_id }} + ' 的记录吗？');"
                                >移动</a>

                            {% endif %}
                        {% elif discount.status == 2 or discount.status == 5 %}
                            {% if discount.todo_userid == session['user_id'] %}
                                <a href="{{ url_for('main.do_discount', id=discount.id, status=status_filter, company_id=request.args.get('company_id')) }}" class="text-link">完成</a>&nbsp;&nbsp;&nbsp;&nbsp;
                                <a href="{{ url_for('main.tracking_discount', id=discount.id,company_id=request.args.get('company_id'))}}" class="text-link edit_link">继续跟踪</a>

                                            {% endif %}
                        {% elif discount.status == 3 %}
                            {% if discount.todo_userid == session['user_id'] %}
                                <a href="{{ url_for('main.tracking_discount', id=discount.id, status=status_filter, company_id=request.args.get('company_id')) }}" class="text-link">继续跟踪</a>
                            {% endif %}
                        {% elif discount.status == 7 %}
                            {% if discount.todo_userid == session['user_id'] %}
                                <a href="{{ url_for('main.do_discount', id=discount.id, status=status_filter, company_id=request.args.get('company_id')) }}" class="text-link">完成</a>
                            {% endif %}
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        <!-- 底部分页控件 -->
        <nav aria-label="Page navigation" class="d-flex justify-content-end pagination-container">
            <ul class="pagination pagination-sm">
                <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.discounts', page=page-1) }}">上一页</a>
                </li>
                {% for num in range(1, total_pages + 1) %}
                    <li class="page-item {% if num == page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('main.discounts', page=num) }}">{{ num }}</a>
                    </li>
                {% endfor %}
                <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.discounts', page=page+1) }}">下一页</a>
                </li>
            </ul>
        </nav>
    </div>
    <script>
        $(document).ready(function () {
            $('[data-bs-toggle="tooltip"]').tooltip();
        });


    </script>
    <script>
        function confirmDelete(event, element) {
            event.preventDefault(); // 阻止默认的链接行为

            const discountId = element.getAttribute('data-id');
            const company_id = element.getAttribute('data-company');
            console.log("discountId", discountId)

            if (confirm(`确定要删除公司ID为 ${company_id} 的记录吗？`)) {
                // 设置表单中的隐藏字段值
                document.getElementById('discount_id').value = discountId;

                // 提交表单
                document.getElementById('delForm').submit();
            }
        }
    </script>

<script>
$(document).ready(function() {
    let debounceTimer;
    let currentEditingCell = null;

    // 只对符合条件的单元格绑定点击事件
    $('.status-cell[data-can-edit="true"]').click(function(e) {
        // 如果已经在编辑另一个单元格，先保存它
        if (currentEditingCell && currentEditingCell[0] !== this) {
            saveStatusChange(currentEditingCell);
        }

        // 设置当前编辑的单元格
        currentEditingCell = $(this);

        // 显示下拉菜单并隐藏显示文本
        const cell = $(this);
        cell.find('.status-display').addClass('d-none');
        const select = cell.find('.status-select').removeClass('d-none');

        // 居中下拉菜单
        const cellWidth = cell.width();
        const selectWidth = 120;
        const leftPosition = (cellWidth - selectWidth) / 2;
        select.css({
            'left': leftPosition + 'px',
            'width': selectWidth + 'px'
        });

        // 聚焦下拉菜单
        setTimeout(() => {
            select.focus();
        }, 10);
    });

    // 保存当下拉菜单失去焦点
    $('.status-select').blur(function() {
        if (currentEditingCell) {
            saveStatusChange(currentEditingCell);
            currentEditingCell = null;
        }
    });

    // 保存当下拉菜单值变化
    $('.status-select').change(function() {
        if (currentEditingCell) {
            saveStatusChange(currentEditingCell);
            currentEditingCell = null;
        }
    });

    // 保存状态变更的函数
    function saveStatusChange(cell) {
        const id = cell.data('id');
        const newStatus = cell.find('.status-select').val();
        const previousStatus = cell.find('.status-select').data('previous');

        // 显示加载指示器并隐藏下拉菜单
        const spinner = cell.find('.spinner-border').removeClass('d-none');
        cell.find('.status-select').addClass('d-none');

        // 清除之前的定时器
        clearTimeout(debounceTimer);

        debounceTimer = setTimeout(() => {
            $.ajax({
                url: '/select_discount_state',
                method: 'POST',
                data: {
                    id: id,
                    status: newStatus
                },
                success: function(response) {
                    spinner.addClass('d-none');
                    if(response.success) {
                        // 更新显示文本
                        const statusText = {
                            '1': '<span class="status-pending">待处理</span>',
                            '2': '已沟通',
                            '3': '已完成',
                            '4': '已提交books',
                            '5': 'books已沟通',
                            '6': '已拒绝',
                            '7': '<span style="color: #13653f;">继续跟踪</span>',
                            '9': '已放弃'
                        };

                        cell.find('.status-display').html(statusText[newStatus]).removeClass('d-none');
                        cell.find('.status-select').data('previous', newStatus);

                        // 更新处理人信息
                        if(newStatus != '1') {
                            const row = cell.closest('tr');
                            row.find('td:nth-child(8)').text(response.handler_name || '');
                            row.find('td:nth-child(9)').text(response.handle_time || '');
                        }
                    } else {
                        toastr.error(response.message || '状态更新失败');
                        // 恢复之前的值
                        cell.find('.status-select').val(previousStatus);
                        cell.find('.status-display').removeClass('d-none');
                    }
                },
                error: function(xhr, status, error) {
                    spinner.addClass('d-none');
                    console.error("请求错误:", error);
                    toastr.error('服务器错误，请重试');
                    // 恢复之前的值
                    cell.find('.status-select').val(previousStatus);
                    cell.find('.status-display').removeClass('d-none');
                }
            });
        }, 300);
    }

    // 存储初始值用于恢复
    $('.status-select').each(function() {
        $(this).data('previous', $(this).val());
    });

    // 点击外部关闭下拉菜单
    $(document).click(function(e) {
        if (!$(e.target).closest('.status-cell').length && currentEditingCell) {
            saveStatusChange(currentEditingCell);
            currentEditingCell = null;
        }
    });
});
</script>

    <style>

        .del_link, .edit_link, .do_link {
            display: block;
            margin-bottom: 5px; /* 设置底部间距 */
        }
.status-cell {
    cursor: pointer;
    position: relative;
    min-width: 100px;
    height: 38px; /* Fixed height to prevent row height change */
}

.status-display {
    display: inline-block;
    padding: 0.375rem 0.75rem;
    line-height: 1.5;
}

.status-pending {
    color: #dc3545;
    font-weight: bold;
}

.status-select {
    position: absolute;
    top: 0;
    z-index: 10;
    margin: 0;
}

.spinner-border {
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 11;
}
    </style>
{% endblock %}
