{% extends 'layout/base.html' %}

{% block content %}
    <div class="container">
        <form action="{{ url_for('main.add_shop_owner_change') }}" method="post" id="transferForm" enctype="multipart/form-data">
            <!-- 公司ID -->
            <div class="row mb-3">
                <label for="company_id" class="col-sm-2 col-form-label">公司ID：<span class="text-danger">*</span></label>
                <div class="col-sm-4">
                    <input type="text" class="form-control" id="company_id" name="company_id" required>
                    <div class="invalid-feedback">请填写公司ID</div>
                </div>
            </div>

            <!-- 新店主 -->
            <div class="row mb-3">
                <label for="new_owner" class="col-sm-2 col-form-label">新店主：</label>
                <div class="col-sm-4">
                    <input type="text" class="form-control" id="new_owner" name="new_owner">
                    <div class="invalid-feedback">请填写新店主</div>
                </div>
            </div>

            <!-- 图片上传区域 -->
            <div class="row mb-3">
                <label class="col-sm-2 col-form-label">证件上传：<span class="text-danger">*</span></label>
                <div class="col-sm-8">
                    <div class="image-upload-container">
                        <!-- 身份证正面 -->
                        <div class="image-upload-box">
                            <input type="file" id="idFrontInput" name="id_front_image" accept="image/*" style="display:none;" >
                            <div class="preview-wrapper" id="idFrontWrapper">
                                <div class="loading-spinner"></div>
                                <img id="idFrontPreview" src="#" alt="身份证正面">
                                <span class="delete-btn">×</span>
                            </div>
                            <div id="idFrontPlaceholder" class="upload-placeholder">
                                <i class="bi bi-card-image fs-5 text-muted"></i>
                                <p class="mb-0 small text-muted">身份证正面</p>
                            </div>
                            <div class="invalid-feedback">请上传身份证正面照片</div>
                        </div>

                        <!-- 身份证反面 -->
                        <div class="image-upload-box">
                            <input type="file" id="idBackInput" name="id_back_image" accept="image/*" style="display:none;" >
                            <div class="preview-wrapper" id="idBackWrapper">
                                <div class="loading-spinner"></div>
                                <img id="idBackPreview" src="#" alt="身份证反面">
                                <span class="delete-btn">×</span>
                            </div>
                            <div id="idBackPlaceholder" class="upload-placeholder">
                                <i class="bi bi-card-image fs-5 text-muted"></i>
                                <p class="mb-0 small text-muted">身份证反面</p>
                            </div>
                            <div class="invalid-feedback">请上传身份证反面照片</div>
                        </div>

                        <!-- 营业执照 -->
                        <div class="image-upload-box">
                            <input type="file" id="licenseInput" name="license_image" accept="image/*" style="display:none;" >
                            <div class="preview-wrapper" id="licenseWrapper">
                                <div class="loading-spinner"></div>
                                <img id="licensePreview" src="#" alt="营业执照">
                                <span class="delete-btn">×</span>
                            </div>
                            <div id="licensePlaceholder" class="upload-placeholder">
                                <i class="bi bi-file-earmark-image fs-5 text-muted"></i>
                                <p class="mb-0 small text-muted">营业执照</p>
                            </div>
                            <div class="invalid-feedback">请上传营业执照照片</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 申请事项 -->
            <div class="row mb-3">
                <label for="content" class="col-sm-2 col-form-label">申请事项：</label>
                <div class="col-sm-8">
                    <textarea class="form-control" id="content" name="content" rows="6" ></textarea>
                    <div class="invalid-feedback">请填写申请事项</div>
                </div>
            </div>

            <!-- 提交按钮 -->
            <div class="row">
                <div class="col-sm-10 offset-sm-2">
                    <button type="submit" class="btn btn-primary me-2">提交</button>
                    <a href="{{ url_for('main.shop_owner_change') }}" class="btn btn-outline-secondary">取消</a>
                </div>
            </div>
        </form>
    </div>

    <style>
        /* 图片上传容器 */
        .image-upload-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        /* 上传框样式 */
        .image-upload-box {
            height: 150px;
            width: 210px;
            position: relative;
            cursor: pointer;
            border: 1px dashed #ced4da;
            border-radius: 4px;
            background: #f8f9fa;
        }

        /* 预览容器 */
        .preview-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            background: #f8f9fa;
        }

        .preview-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 5px;
        }

        /* 加载指示器 */
        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #007bff;
            animation: spin 1s linear infinite;
            display: none;
            z-index: 5;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* 删除按钮 */
        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 22px;
            height: 22px;
            background: rgba(255,0,0,0.7);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            z-index: 10;
            border: 1px solid white;
        }

        /* 占位符样式 */
        .upload-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #6c757d;
        }

        /* 必填字段标记 */
        .text-danger {
            color: #dc3545;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .image-upload-box {
                width: 100%;
            }
        }
    </style>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化所有图片上传组件
        const imageUploads = [
            { inputId: 'idFrontInput', wrapperId: 'idFrontWrapper', placeholderId: 'idFrontPlaceholder', previewId: 'idFrontPreview' },
            { inputId: 'idBackInput', wrapperId: 'idBackWrapper', placeholderId: 'idBackPlaceholder', previewId: 'idBackPreview' },
            { inputId: 'licenseInput', wrapperId: 'licenseWrapper', placeholderId: 'licensePlaceholder', previewId: 'licensePreview' }
        ];

        // 初始化每个图片上传框
        imageUploads.forEach(upload => {
            initImageUpload(upload.inputId, upload.wrapperId, upload.placeholderId, upload.previewId);
        });

        // 表单提交处理
        const form = document.getElementById('transferForm');
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            // 验证表单
            if (validateForm()) {
                const formData = new FormData(this);
                const submitBtn = this.querySelector('button[type="submit"]');

                // 显示提交加载状态
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 提交中...';

                try {
                    // 压缩所有图片并添加到FormData
                    await Promise.all(imageUploads.map(async upload => {
                        const input = document.getElementById(upload.inputId);
                        if (input.files && input.files[0]) {
                            const compressedFile = await compressImage(input.files[0]);
                            formData.set(input.name, compressedFile, compressedFile.name);
                        }
                    }));

                    // 提交表单
                    const response = await fetch(this.action, {
                        method: 'POST',
                        body: formData,
                    });

                    if (!response.ok) throw new Error('网络响应不正常');

                    const data = await response.json();
                    if (data.success) {
                        // 提交成功，跳转页面
                        setTimeout(() => {
                            window.location.href = "{{ url_for('main.shop_owner_change') }}";
                        }, 1500);
                    } else {
                        throw new Error(data.message || '提交失败');
                    }
                } catch (error) {
                    console.error('提交错误:', error);
                    showErrorAlert(error.message || '提交过程中发生错误');
                    submitBtn.disabled = false;
                    submitBtn.textContent = '提交';
                }
            }
        });

        // 初始化图片上传功能
        function initImageUpload(inputId, wrapperId, placeholderId, previewId) {
            const input = document.getElementById(inputId);
            const wrapper = document.getElementById(wrapperId);
            const placeholder = document.getElementById(placeholderId);
            const preview = document.getElementById(previewId);
            const deleteBtn = wrapper.querySelector('.delete-btn');
            const spinner = wrapper.querySelector('.loading-spinner');

            // 点击上传框触发文件选择
            placeholder.closest('.image-upload-box').addEventListener('click', function(e) {
                if (e.target !== deleteBtn) {
                    input.click();
                }
            });

            // 删除图片
            deleteBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                resetImageInput(input, wrapper, placeholder, preview);
            });

            // 文件选择变化事件
            input.addEventListener('change', async function() {
                if (this.files && this.files[0]) {
                    try {
                        // 显示加载状态
                        placeholder.style.display = 'none';
                        wrapper.style.display = 'block';
                        spinner.style.display = 'block';
                        preview.style.opacity = '0.5';

                        // 压缩图片并显示预览
                        const compressedFile = await compressImage(this.files[0]);
                        preview.src = await readFileAsDataURL(compressedFile);

                        // 替换原始文件为压缩后的文件
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(compressedFile);
                        this.files = dataTransfer.files;

                        // 显示预览
                        preview.onload = function() {
                            spinner.style.display = 'none';
                            preview.style.opacity = '1';
                            input.classList.remove('is-invalid');
                        };
                    } catch (error) {
                        console.error('图片处理错误:', error);
                        showErrorAlert('图片处理失败，请重试');
                        resetImageInput(input, wrapper, placeholder, preview);
                    }
                }
            });
        }

        // 图片压缩函数
        async function compressImage(file, maxWidth = 1024, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        // 计算缩放比例
                        const scale = Math.min(maxWidth / img.width, 1);
                        const width = img.width * scale;
                        const height = img.height * scale;

                        // 创建canvas进行压缩
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // 转换为Blob对象
                        canvas.toBlob((blob) => {
                            if (!blob) {
                                reject(new Error('图片压缩失败'));
                                return;
                            }

                            // 保留原始文件名但修改扩展名为jpg
                            const fileName = file.name.replace(/\.[^/.]+$/, '.jpg');
                            const compressedFile = new File([blob], fileName, {
                                type: 'image/jpeg',
                                lastModified: Date.now()
                            });
                            resolve(compressedFile);
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = () => reject(new Error('图片加载失败'));
                    img.src = event.target.result;
                };
                reader.onerror = () => reject(new Error('文件读取失败'));
                reader.readAsDataURL(file);
            });
        }

        // 将文件读取为DataURL
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(new Error('文件读取失败'));
                reader.readAsDataURL(file);
            });
        }

        // 重置图片输入状态
        function resetImageInput(input, wrapper, placeholder, preview) {
            input.value = '';
            preview.src = '#';
            wrapper.style.display = 'none';
            placeholder.style.display = 'flex';
            input.classList.add('is-invalid');

            // 添加淡出效果
            wrapper.style.opacity = '0';
            wrapper.style.transition = 'opacity 0.3s';
            setTimeout(() => {
                wrapper.style.opacity = '1';
            }, 10);
        }

        // 表单验证
        function validateForm() {
            let isValid = true;
            const form = document.getElementById('transferForm');

            // 验证文本字段
            const requiredInputs = form.querySelectorAll('input[required], textarea[required]');
            requiredInputs.forEach(input => {
                if (!input.value.trim()) {
                    input.classList.add('is-invalid');
                    isValid = false;
                } else {
                    input.classList.remove('is-invalid');
                }
            });

            // 验证文件上传
            const fileInputs = form.querySelectorAll('input[type="file"][required]');
            fileInputs.forEach(input => {
                if (!input.files || input.files.length === 0) {
                    input.classList.add('is-invalid');
                    isValid = false;
                } else {
                    input.classList.remove('is-invalid');
                }
            });

            return isValid;
        }

        // 显示错误提示
        function showErrorAlert(message) {
            // 移除现有的错误提示
            const existingAlert = document.querySelector('.alert.alert-danger');
            if (existingAlert) existingAlert.remove();

            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger position-fixed top-0 start-50 translate-middle-x mt-3';
            alertDiv.style.zIndex = '9999';
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    });
    </script>
{% endblock %}