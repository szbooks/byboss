{% extends 'layout/base.html' %}

{% block content %}
    <div class="content-area">
        <!-- 顶部操作栏 -->
        <div class="d-flex align-items-center flex-wrap mb-3">
            <!-- 操作按钮 -->
            <a href="{{ url_for('main.add_vip_refund') }}" class="btn btn-primary me-2 mb-2">申请vip退费</a>
            <!-- 查询表单 -->
            <form action="{{ url_for('main.vip_refund') }}" method="get" class="d-flex align-items-center mb-2 flex-grow-0">
                <select class="form-select me-2" name="status" id="status">
                    <option value="">所有状态</option>
                    <option value="1" {% if status_filter == '1' %}selected{% endif %}>待处理</option>
                    <option value="2" {% if status_filter == '2' %}selected{% endif %}>已完成</option>
                    <option value="3" {% if status_filter == '3' %}selected{% endif %}>已拒绝</option>
                </select>

                <select class="form-select me-2" name="payment_type" id="payment_type">
                    <option value="">退费类型</option>
                    <option value="vip" {% if payment_type_filter == 'vip' %}selected{% endif %}>vip</option>
                    <option value="sms" {% if payment_type_filter == 'sms' %}selected{% endif %}>短信</option>
                  </select>

                <input type="text" class="input-group-text me-2" name="company_id" placeholder="输入公司ID" value="{{ request.args.get('company_id', '') }}">
                <button type="submit" class="btn btn-outline-primary">查询</button>
            </form>
             <div class="text-danger">公司vip退费，可申请此表</div>
        </div>
        <table class="table table-striped table-bordered table-light table-hover">
            <thead>
            <tr>
                <th>公司ID</th>
                <th>申请事项</th>
                <th>退费类型</th>
                <th>退款金额（元）</th>
                <th>状态</th>
                <th>创建人</th>
                <th>创建时间</th>
                <th>处理人</th>
                <th>处理时间</th>
                <th>处理意见</th>
                <th>备注</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            {% for result  in results %}
                <tr style="">
                    <td>
                         <a href="https://www.bypms.cn/admin/user/fakelogin?companyId={{ result.company_id }}" target="_blank">
                                {{ result.company_id }}
                            </a>
                    </td>
                    <td style="max-width: 150px;">
                        <span class="wrap-ellipsis" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ result.content }}">{{ result.content }}</span>
                    </td>
{#                    <td style="max-width: 50px;">{% if result.payment_type %}{{ result.payment_type }}{% else %}{{ "" }}{% endif %}</td>#}
                <td style="max-width: 50px;">
                 {% if result.payment_type == "sms" %}
                     短信
                 {% else %}
                     {{ result.payment_type|default('', true) }}
                        {% endif %}
                </td>



                    <td style="max-width: 50px;">{% if result.price %}{{ result.price }}{% else %}{{ "" }}{% endif %}</td>
                    <td style="max-width: 70px;">
                        {% if result.status == 1 %}
                            <span class="status-pending">待处理</span>
                        {% elif result.status == 2 %}
                            已完成
                        {% elif result.status == 3 %}
                            已拒绝
{#                        {% elif special.status == 4 %}#}
{#                            已提交books#}
{#                        {% elif special.status == 5 %}#}
{#                            books已沟通#}
{#                        {% elif special.status == 6 %}#}
{#                            已拒绝#}
                        {% else %}
                            未知状态
                        {% endif %}
                    </td>
                    <td style="max-width: 50px;">{{ result.create_user_name }}</td>
                    <td style="max-width: 100px;">{{ result.create_datetime }}</td>
                    <td style="max-width: 50px;">{{ result.todo_user_name }}</td>
                    {% if result.todo_datetime == None %}
                        <td></td>
                    {% else %}
                        <td style="max-width: 100px;">{{ result.todo_datetime }}</td>
                    {% endif %}
                    {#                    {% if discount.final_plan is none or discount.final_plan == '' %}#}
                    <td style="max-width: 150px;">
                        <span class="wrap-ellipsis" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ result.final_plan }}">{{ result.final_plan|default('', true) }}</span>
                    </td>
                    <td style="max-width: 150px;">
                        <span class="wrap-ellipsis" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ result.todo_remark }}">{{ result.todo_remark|default('', true) }}</span>
                    </td>
                    <td>
                        {% if result.status == 1 %}
                            {% if result.todo_account_id == session['user_id'] %}
                                <a href="{{ url_for('main.do_vip_refund', id=result.id) }}" class="text-link do_link">处理</a>
                                <form id="delForm" action="{{ url_for('main.del_vip_refund') }}" method="POST">
                                     <input type="hidden" name="vip_refund_id" id="vip_refund_id" value="">
                                </form>
                                <a href="#" id="del_vip_refund" data-id="{{ result.id }}" data-company="{{ result.company_id }}" onclick="confirmDelete(event, this)" class="text-link del_link"
                                style="text-decoration: underline;">删除</a>
                            {% endif %}
                            <a href="{{ url_for('main.edit_vip_refund', id=result.id, company_id=request.args.get('company_id')) }}" class="text-link edit_link">编辑</a>
                        {% elif result.status == 2 or result.status == 3%}
                            {% if result.todo_account_id == session['user_id'] %}
                                <a href="{{ url_for('main.do_vip_refund', id=result.id) }}" class="text-link">备注</a>
                            {% endif %}
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        <!-- 底部分页控件 -->
        <nav aria-label="Page navigation" class="d-flex justify-content-end pagination-container">
            <ul class="pagination pagination-sm">
                <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.vip_refund', page=page-1) }}">上一页</a>
                </li>
                {% for num in range(1, total_pages + 1) %}
                    <li class="page-item {% if num == page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('main.vip_refund', page=num) }}">{{ num }}</a>
                    </li>
                {% endfor %}
                <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.vip_refund', page=page+1) }}">下一页</a>
                </li>
            </ul>
        </nav>
    </div>
    <script>
        $(document).ready(function () {
            $('[data-bs-toggle="tooltip"]').tooltip();
        });
    </script>

            <script>
function confirmDelete(event, element) {
    event.preventDefault(); // 阻止默认的链接行为

    const resultId = element.getAttribute('data-id');
    const company_id = element.getAttribute('data-company');

    if (confirm(`确定要删除公司ID为 ${company_id}的记录吗？`)) {
        // 设置表单中的隐藏字段值
        document.getElementById('vip_refund_id').value = resultId;
        // 提交表单
        document.getElementById('delForm').submit();
    }
}
</script>
    <style>
    .text-danger {
        color: #dc6a35; /* 或其他您希望的颜色 */
        margin-left: 15px; /* 添加左侧间距 */
    }

    .del_link, .edit_link ,.do_link{
            display: block;
            margin-bottom: 5px; /* 设置底部间距 */
        }


    </style>
{% endblock %}
