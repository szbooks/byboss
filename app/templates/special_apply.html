{% extends 'layout/base.html' %}

{% block content %}
    <div class="content-area">
        <!-- 顶部操作栏 -->
        <div class="d-flex align-items-center flex-wrap mb-3">
            <!-- 操作按钮 -->
            <a href="{{ url_for('main.add_transfer') }}" class="btn btn-primary me-2 mb-2">申请数据调整</a>
            <!-- 查询表单 -->
            <form action="{{ url_for('main.special_apply') }}" method="get" class="d-flex align-items-center mb-2 flex-grow-0">
                <select class="form-select me-2" name="status" id="status">
                    <option value="">所有状态</option>
                    <option value="1" {% if status_filter == '1' %}selected{% endif %}>待处理</option>
                    <option value="2" {% if status_filter == '2' %}selected{% endif %}>已完成</option>
                    <option value="3" {% if status_filter == '3' %}selected{% endif %}>已拒绝</option>
                </select>
                <input type="text" class="input-group-text me-2" name="company_id" placeholder="输入公司ID" value="{{ request.args.get('company_id', '') }}">
                <button type="submit" class="btn btn-outline-primary">查询</button>
            </form>
             <div class="text-danger">公司的房号、费用、到期日转移到其他公司，可申请此表</div>
        </div>
         <p class="record_custom-margin">
            记录总数: {{ total_count }} &emsp;&emsp;&emsp;
            待处理: {{ status1_count }}&emsp;&emsp;&emsp;
            已完成: {{ status2_count }}&emsp;&emsp;&emsp;
            已拒绝: {{ status3_count }}&emsp;&emsp;&emsp;

{#            <span style="color: red;">未认领：{{ unclaimed_count }}</span>&emsp;&emsp;&emsp;#}
{#            待处理：{{ status1_count }}（初步沟通），{{ step_two_count }}（直连），{{ step_four_count }}（转售后），{{ step_six_count }}（放弃）#}
        </p>
        <table class="table table-striped table-bordered table-light table-hover">
            <thead>
            <tr>
                <th>公司ID</th>
                <th>申请事项</th>
                <th>联系方式</th>
                <th>状态</th>
                <th>创建人</th>
                <th>创建时间</th>
                <th>处理人</th>
                <th>处理时间</th>
                <th>处理意见</th>
                <th>备注</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            {% for special  in results %}
                <tr style="">
                    <td>
                         <a href="https://www.bypms.cn/admin/user/fakelogin?companyId={{ special.company_id }}" target="_blank">
                                {{ special.company_id }}
                            </a>
                    </td>
                    <td style="max-width: 150px;">
                        <span class="wrap-ellipsis" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ special.content }}">{{ special.content }}</span>
                    </td>
                    <td style="max-width: 70px;">{% if special.phone %}{{ special.phone }}{% else %}{{ "" }}{% endif %}</td>
                    <td style="max-width: 70px;">
                        {% if special.status == 1 %}
                            <span class="status-pending">待处理</span>
                        {% elif special.status == 2 %}
                            已完成
                        {% elif special.status == 3 %}
                            已拒绝
{#                        {% elif special.status == 4 %}#}
{#                            已提交books#}
{#                        {% elif special.status == 5 %}#}
{#                            books已沟通#}
{#                        {% elif special.status == 6 %}#}
{#                            已拒绝#}
                        {% else %}
                            未知状态
                        {% endif %}
                    </td>
                    <td style="max-width: 50px;">{{ special.create_user_name }}</td>
                    <td style="max-width: 100px;">{{ special.create_datetime }}</td>
                    <td style="max-width: 50px;">{{ special.todo_user_name }}</td>
                    {% if special.todo_datetime == None %}
                        <td></td>
                    {% else %}
                        <td style="max-width: 100px;">{{ special.todo_datetime }}</td>
                    {% endif %}
                    {#                    {% if discount.final_plan is none or discount.final_plan == '' %}#}
                    <td style="max-width: 150px;">
                        <span class="wrap-ellipsis" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ special.final_plan }}">{{ special.final_plan|default('', true) }}</span>
                    </td>
                    <td style="max-width: 150px;">
                        <span class="wrap-ellipsis" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ special.todo_remark }}">{{ special.todo_remark|default('', true) }}</span>
                    </td>
                    <td>
                        {% if special.status == 1 %}
                            {% if special.todo_account_id == session['user_id'] %}
                                <a href="{{ url_for('main.do_transfer', id=special.id) }}" class="text-link do_link">处理</a>
                                <form id="delForm" action="{{ url_for('main.del_special') }}" method="POST">
                                     <input type="hidden" name="special_id" id="special_id" value="">
                                </form>
                                <a href="#" id="del_special" data-id="{{ special.id }}" data-company="{{ special.company_id }}" onclick="confirmDelete(event, this)" class="text-link del_link"
                                style="text-decoration: underline;">删除</a>

                                <a
                                        href="{{ url_for('main.move_specia', id=special.id,company_id=request.args.get('company_id'))}}"
                                        class="text-link edit_link"
                                        onclick="return confirm('确定要移动公司 ' + {{ special.company_id }} + ' 的记录吗？');"
                                >移动</a>
                            {% endif %}
                            <a href="{{ url_for('main.edit_special', id=special.id, status=status_filter, company_id=request.args.get('company_id')) }}" class="text-link edit_link">编辑</a>
                        {% elif special.status == 2 or special.status == 3%}
                            {% if special.todo_account_id == session['user_id'] %}
                                <a href="{{ url_for('main.do_transfer', id=special.id) }}" class="text-link">备注</a>
                            {% endif %}
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        <!-- 底部分页控件 -->
        <nav aria-label="Page navigation" class="d-flex justify-content-end pagination-container">
            <ul class="pagination pagination-sm">
                <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.special_apply', page=page-1) }}">上一页</a>
                </li>
                {% for num in range(1, total_pages + 1) %}
                    <li class="page-item {% if num == page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('main.special_apply', page=num) }}">{{ num }}</a>
                    </li>
                {% endfor %}
                <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.special_apply', page=page+1) }}">下一页</a>
                </li>
            </ul>
        </nav>
    </div>
{#    <script>#}
{#        $(document).ready(function () {#}
{#            $('[data-bs-toggle="tooltip"]').tooltip();#}
{#        });#}
{#    </script>#}
    <style>
    .text-danger {
        color: #dc6a35; /* 或其他您希望的颜色 */
        margin-left: 15px; /* 添加左侧间距 */
    }

    .del_link, .edit_link ,.do_link{
            display: block;
            margin-bottom: 5px; /* 设置底部间距 */
        }


    </style>

        <script>
function confirmDelete(event, element) {
    event.preventDefault(); // 阻止默认的链接行为

    const specialId = element.getAttribute('data-id');
    const company_id = element.getAttribute('data-company');
    console.log("specialId",specialId)

    if (confirm(`确定要删除公司ID为 ${company_id} specialId是：${specialId} 的记录吗？`)) {
        // 设置表单中的隐藏字段值
        document.getElementById('special_id').value = specialId;
        console.log("specialId2",specialId)
        // 提交表单
        document.getElementById('delForm').submit();
    }
}
</script>
{% endblock %}
