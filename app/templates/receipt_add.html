{% extends 'layout/base.html' %}

{% block content %}
    <div class="container">
        <form action="{{ url_for('main.add_receipt') }}" method="post" id="receiptForm">


                        <div class="row mb-3 align-items-center">  <!-- 添加align-items-center确保垂直居中 -->
    <label for="partner" class="col-sm-1 col-form-label">合作商：</label>
    <div class="col-sm-5 d-flex align-items-center">  <!-- 使用d-flex布局 -->
        <select class="form-select flex-grow-1" id="partner" name="partner" style="max-width: 70%">  <!-- 限制下拉框宽度 -->
            <option value="">无</option>
            <option value="999604">云房卡</option>
            <option value="999622">深圳智创</option>
            <option value="999609">忆客</option>
            <option value="999603">享住呗</option>
            <option value="999621">小满</option>
            <option value="230592">筑宿</option>
            <option value="999626">云闪住</option>
            <option value="999602">闪住</option>
        </select>
            <span id="partner_feedback" class="ms-2 text-danger" style="white-space: nowrap;"></span>
    </div>
</div>


            <!-- 公司ID -->
            <div class="row mb-3">
                <label for="company_id" class="col-sm-1 col-form-label">公司ID：<span class="text-danger">*</span></label>
                <div class="col-sm-5 d-flex align-items-center">
                    <input type="text" class="form-control" id="company_id" name="company_id" required>
                    <button type="button" class="btn btn-outline-primary ms-2" id="searchCompanyBtn" style="width: 60px; height: 35px;">查询</button>
                </div>
                <div style="margin-left: 110px;color: #2E75FF">点击查询按钮可自动填写，历史已存在的公司信息</div>
                <div id="company_id_feedback" class="form-text text-danger" style="margin-left: 110px;"></div>
            </div>


            <!-- 发票头 -->
            <div class="row mb-3">
                <label for="invoice_head" class="col-sm-1 col-form-label">开票公司：<span class="text-danger">*</span></label>
                <div class="col-sm-5 d-flex align-items-center">
                    <input type="text" class="form-control" id="invoice_head" name="invoice_head" required>
                    <button type="button" class="btn btn-outline-primary ms-2" id="searchheadBtn" style="width: 60px; height: 35px;">查询</button>
                </div>
                <div id="head_feedback" class="form-text text-danger" style="margin-left: 110px;"></div>
            </div>


{##}
{#            <!-- 发票头 -->#}
{#            <div class="row mb-3">#}
{#                <label for="invoice_head" class="col-sm-1 col-form-label">开票公司：</label>#}
{#                <div class="col-sm-5">#}
{#                    <input type="text" class="form-control" id="invoice_head" name="invoice_head">#}
{#                </div>#}
{#            </div>#}


            <!-- 开票金额 -->
            <div class="row mb-3">
                <label for="price" class="col-sm-1 col-form-label">开票金额：</label>
                <div class="col-sm-5">
                    <input type="text" class="form-control" id="price" name="price">
                </div>
            </div>

            <!-- 税号 -->
            <div class="row mb-3">
                <label for="tax_id" class="col-sm-1 col-form-label">税号：</label>
                <div class="col-sm-5">
                    <input type="text" class="form-control" id="tax_id" name="tax_id">
                </div>
            </div>

            <!-- 开户行 -->
            <div class="row mb-3">
                <label for="khh" class="col-sm-1 col-form-label">开户行：</label>
                <div class="col-sm-5">
                    <input type="text" class="form-control" id="khh" name="khh">
                </div>
            </div>

            <!-- 银行账号 -->
            <div class="row mb-3">
                <label for="bank_account" class="col-sm-1 col-form-label">银行账号：</label>
                <div class="col-sm-5">
                    <input type="text" class="form-control" id="bank_account" name="bank_account">
                </div>
            </div>

            <!-- 地址 -->
            <div class="row mb-3">
                <label for="addr" class="col-sm-1 col-form-label">地址：</label>
                <div class="col-sm-5">
                    <input type="text" class="form-control" id="addr" name="addr">
                </div>
            </div>

            <!-- 联系电话 -->
            <div class="row mb-3">
                <label for="phone" class="col-sm-1 col-form-label">联系电话：</label>
                <div class="col-sm-5">
                    <input type="tel" class="form-control" id="phone" name="phone" pattern="(\+?\d[- .]*){7,13}">
                </div>
            </div>

            <!-- 备注 -->
            <div class="row mb-3">
                <label for="remark" class="col-sm-1 col-form-label">基本信息：</label>
                <div class="col-sm-5">
                    <textarea class="form-control" id="remark" name="remark" style="height: 150px"></textarea>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-10 offset-sm-1">
                    <button type="submit" class="btn btn-primary me-2">提交</button>
                    <a href="{{ url_for('main.receipts') }}" class="btn btn-secondary">取消</a>
                </div>
            </div>
        </form>

        <script>
            $(document).ready(function () {
                // 监听查询按钮的点击事件
                $('#searchCompanyBtn').on('click', function () {
                    var companyId = $('#company_id').val();

                    // 清除之前的反馈信息
                    $('#company_id_feedback').empty();

                    // 发送 AJAX 请求来查询公司 ID
                    $.ajax({
                        url: '/old_search_company',
                        method: 'GET',
                        data: {
                            'company_id': companyId
                        },
                        success: function (response) {
                            if (response && response.found) {
                                // 如果找到了数据，清除反馈信息
                                $('#company_id_feedback').empty();
                                {#$('#company_id_feedback').text(data.company_id);#}

                                // 更新表单字段
                                updateFormFields(response.data);
                            } else {
                                // 如果未找到数据，在输入框下方显示提示信息
                                $('#company_id_feedback').empty();
                                $('#company_id_feedback').text('未找到数据');
                            }
                        },
                        error: function (error) {
                            console.error('Failed to search company:', error);
                            $('#company_id_feedback').text('查询失败，请稍后再试');
                        }
                    });
                });

                // 监听合作商下拉框变化
   $('#partner').on('change', function() {
    const partnerId = $(this).val();
    const feedback = $('#partner_feedback'); // 使用新的ID

    if (partnerId) {
        // 发送AJAX请求
        $.ajax({
            url: '/old_search_company',
            method: 'GET',
            data: { 'partner_id': partnerId },
             success: function(response) {
                if (response?.found) {
                    feedback.empty();
                    resetFormFields();
                    updateFormFields(response.data);
                } else {
                    resetFormFields();
                    feedback.text('未找到数据');
                }
            },
            error: () => feedback.text('查询失败')
        });
    } else {
        resetFormFields();
        feedback.empty();
    }
});


    // 清空表单字段的函数
function resetFormFields() {
    $('#invoice_head').val('');
    $('#tax_id').val('');
    $('#khh').val('');
    $('#bank_account').val('');
    $('#addr').val('');
    $('#remark').val('');
    $('#phone').val('');
    $('#company_id_feedback').empty();
}




                // 更新表单字段的函数
                function updateFormFields(data) {
                    {#$('#company_id_feedback').text("已查找到公司:"+data.company_id+" 的数据");#}
                    $('#invoice_head').val(data.invoice_head);
                    $('#tax_id').val(data.tax_id);
                    $('#khh').val(data.khh);
                    $('#bank_account').val(data.bank_account);
                    $('#addr').val(data.addr);
                    $('#remark').val(data.remark);  // 假设数据中包含 remark 字段
                    $('#phone').val(data.phone);

                }

                 // 监听查询按钮的点击事件
                $('#searchheadBtn').on('click', function () {
                    var head = $('#invoice_head').val();

                    // 清除之前的反馈信息
                    $('#head_feedback').empty();

                    // 发送 AJAX 请求来查询公司 ID
                    $.ajax({
                        url: '/old_search_company',
                        method: 'GET',
                        data: {
                            'invoice_head': head
                        },
                        success: function (response) {
                            if (response && response.found) {
                                // 如果找到了数据，清除反馈信息
                                $('#head_feedback').empty();
                                {#$('#company_id_feedback').text(data.company_id);#}

                                // 更新表单字段
                                updateFormFields(response.data);
                            } else {
                                // 如果未找到数据，在输入框下方显示提示信息
                                $('#head_feedback').empty();
                                $('#head_feedback').text('未找到数据');
                            }
                        },
                        error: function (error) {
                            console.error('Failed to search company:', error);
                            $('#head_feedback').text('查询失败，请稍后再试');
                        }
                    });
                });

                // 更新表单字段的函数
                function updateFormFields(data) {
                    {#$('#head_feedback').text("已查找到公司:"+data.company_id+" 的数据");#}
                    $('#invoice_head').val(data.invoice_head);
                    $('#tax_id').val(data.tax_id);
                    $('#khh').val(data.khh);
                    $('#bank_account').val(data.bank_account);
                    $('#addr').val(data.addr);
                    $('#remark').val(data.remark);  // 假设数据中包含 remark 字段
                    $('#phone').val(data.phone);
                }
            });



        </script>
    </div>
       <script>
    document.getElementById('receiptForm').addEventListener('submit', function() {
        // 禁用提交按钮
        document.querySelector('button[type="submit"]').disabled = true;
    });
</script>
{% endblock %}