{% extends 'layout/base.html' %}

{% block content %}
    <div class="content-area">
        <!-- 顶部操作栏 -->
        <div class="d-flex align-items-center flex-wrap mb-3">
            <!-- 操作按钮 -->
            <a href="{{ url_for('main.add_api') }}" class="btn btn-primary me-2 mb-2">添加接口授权</a>
            <!-- 查询表单 -->
            <form action="{{ url_for('main.api_list') }}" method="get" class="d-flex align-items-center mb-2 flex-grow-0">
                <input type="text" class="input-group-text me-2" name="company_id" placeholder="输入公司ID" value="{{ request.args.get('company_id', '') }}">
                <input type="text" class="input-group-text me-2" name="appid" placeholder="输入APPID" value="{{ request.args.get('appid', '') }}">
                <input type="text" class="input-group-text me-2" name="yuming" placeholder="输入域名" value="{{ request.args.get('yuming', '') }}">
                <select class="form-select me-2 search_operator" name="channel" id="channel">
                    <option value=''>请选择渠道</option>
                    {% for channel in channels %}
                        <option value='{{ channel.yuming }}' {% if status_filter.channel_address == channel.yuming %}selected{% endif %}>{{ channel.channel }}</option>
                    {% endfor %}
                </select>


                <button type="submit" class="btn btn-outline-primary">查询</button>
            </form>

        </div>
        <p class="record_custom-margin">记录数: {{ total_count }} </p>
        <table class="table table-striped table-bordered table-light table-hover">
            <thead>
            <tr>
                <th>公司ID</th>
                <th>公司名称</th>
                <th>app_id</th>
                <th>app_secret</th>
                <th>状态</th>
                <th>推送地址</th>
                <th>创建人</th>
                <th>创建时间</th>
                {#                <th>备注</th>#}
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            {% for result  in results %}
                <tr style="">
                    <td>
                        <a href="https://www.bypms.cn/admin/user/fakelogin?companyId={{ result.granted_company_id }}" target="_blank">
                            {{ result.granted_company_id }}
                        </a>
                    </td>
                    <td style="max-width: 100px;">{{ result.name|default('', true) }}</td>
                    <td style="max-width: 50px;">{{ result.app_id|default('', true) }}</td>
                    <td style="max-width: 200px;">{{ result.app_secret|default('', true) }}</td>
                    <td>{{ result.state|default('', true) }}</td>
                    <td style="max-width: 300px;">
                        <span class="show-more" style="cursor: pointer;">
                            <span class="wrap-ellipsis" data-field="num">{{ result.config|default('', true) }}</span> <!-- Unicode for "Loading" icon -->
                            <span class="glyphicon glyphicon-triangle-bottom"></span>
                        </span>
                    </td>
                    <td>{{ result.creator|default('', true) }}</td>
                    <td>{{ result.create_time|default('', true) }}</td>

                    <td>
                        <a href="#" class="copyButton" data-app-id="{{ result.app_id }}" data-order-id="{{ result.app_secret }}" data-company_id="{{ result.granted_company_id }}">复制</a>
                        <a href="{{ url_for('main.do_api', id=result.id) }}" class="text-link">编辑</a>
                    </td>

                </tr>
            {% endfor %}
            </tbody>
        </table>
        <!-- 底部分页控件 -->
        {#        <nav aria-label="Page navigation" class="d-flex justify-content-end pagination-container">#}
        {#            <ul class="pagination pagination-sm">#}
        {#                <li class="page-item {% if page <= 1 %}disabled{% endif %}">#}
        {#                    <a class="page-link" href="{{ url_for('main.vip_refund', page=page-1) }}">上一页</a>#}
        {#                </li>#}
        {#                {% for num in range(1, total_pages + 1) %}#}
        {#                    <li class="page-item {% if num == page %}active{% endif %}">#}
        {#                        <a class="page-link" href="{{ url_for('main.api_list', page=num) }}">{{ num }}</a>#}
        {#                    </li>#}
        {#                {% endfor %}#}
        {#                <li class="page-item {% if page >= total_pages %}disabled{% endif %}">#}
        {#                    <a class="page-link" href="{{ url_for('main.api_list', page=page+1) }}">下一页</a>#}
        {#                </li>#}
        {#            </ul>#}
        {#        </nav>#}
    </div>
    <nav aria-label="Page navigation" class="d-flex justify-content-end pagination-container">
        <ul class="pagination pagination-sm">
            <!-- 上一页 -->
            <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('main.api_list', page=page-1) }}">上一页</a>
            </li>

            <!-- 首页 -->
            <li class="page-item {% if page == 1 %}active{% endif %}">
                <a class="page-link" href="{{ url_for('main.api_list', page=1) }}">1</a>
            </li>

            <!-- 省略号（如果当前页不在前几页） -->
            {% if start_page > 2 %}
                <li class="page-item disabled">
                    <span class="page-link">...</span>
                </li>
            {% endif %}

            <!-- 动态页码范围 -->
            {% for num in range(start_page, end_page + 1) %}
                <li class="page-item {% if num == page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('main.api_list', page=num) }}">{{ num }}</a>
                </li>
            {% endfor %}

            <!-- 省略号（如果当前页不在后几页） -->
            {% if end_page < total_pages - 1 %}
                <li class="page-item disabled">
                    <span class="page-link">...</span>
                </li>
            {% endif %}

            <!-- 末页 -->
            {% if total_pages > 1 %}
                <li class="page-item {% if page == total_pages %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('main.api_list', page=total_pages) }}">{{ total_pages }}</a>
                </li>
            {% endif %}

            <!-- 下一页 -->
            <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('main.api_list', page=page+1) }}">下一页</a>
            </li>
        </ul>
    </nav>


    <script>
        $(document).ready(function () {
            $('[data-bs-toggle="tooltip"]').tooltip();

            // 绑定点击事件
            $('.copyButton').on('click', function (event) {
                event.preventDefault();

                var appId = $(this).data('app-id');
                var secret = $(this).data('order-id');
                var company_id = $(this).data('company_id');
                var formattedString = `company_id: ${company_id}\nappid: ${appId}\nsecret: ${secret}`;

                // 创建临时textarea元素
                var $temp = $("<textarea>");
                $("body").append($temp);
                $temp.val(formattedString).select();

                try {
                    // 使用document.execCommand方法
                    var success = document.execCommand("copy");
                    if (success) {
                        showCopySuccessToast();
                    } else {
                        console.error("复制失败，请手动复制");
                    }
                } catch (err) {
                    console.error('复制到剪贴板失败:', err);
                }

                // 移除临时元素
                $temp.remove();
            });


            function showCopySuccessToast() {
                var toastDiv = document.createElement('div');
                toastDiv.textContent = '数据已复制到剪贴板';
                toastDiv.style.position = 'fixed';
                toastDiv.style.top = '10%';
                toastDiv.style.left = '50%';
                toastDiv.style.transform = 'translateX(-50%)';
                toastDiv.style.backgroundColor = '#f8d7da';
                toastDiv.style.color = '#721c24';
                toastDiv.style.padding = '10px';
                toastDiv.style.borderRadius = '5px';
                toastDiv.style.zIndex = '1000';
                toastDiv.style.minWidth = '250px';
                toastDiv.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
                document.body.appendChild(toastDiv);

                // 移除提示信息
                setTimeout(function () {
                    document.body.removeChild(toastDiv);
                }, 2000);
            }
        });
    </script>

    <script>
        function updateChannelDetails() {
            var channelSelect = document.getElementById("channel");
            var channelNameInput = document.getElementById("channel_name");
            var pushaddressInput = document.getElementById("pushaddress");
            var channelNameRow = document.getElementById("channelNameRow");
            var pushaddressRow = document.getElementById("pushaddressRow");

            var selectedOption = channelSelect.options[channelSelect.selectedIndex];
            var channelName = selectedOption.getAttribute('data-name');
            var pushaddress = selectedOption.getAttribute('data-address');

            if (channelSelect.value !== '') {
                channelNameInput.value = channelName;
                pushaddressInput.value = pushaddress;
                channelNameRow.style.display = "flex";
                pushaddressRow.style.display = "flex";
            } else {
                channelNameInput.value = '';
                pushaddressInput.value = '';
                channelNameRow.style.display = "none";
                pushaddressRow.style.display = "none";
            }
        }

    </script>

    <style>
        .text-danger {
            color: #dc6a35; /* 或其他您希望的颜色 */
            margin-left: 15px; /* 添加左侧间距 */
        }

        /* 自定义单元格样式 */
        .wrap-ellipsis {
            display: -webkit-box;
            -webkit-line-clamp: 5; /* 显示的最大行数 */
            -webkit-box-orient: vertical;
            overflow: hidden;
        {#max-width: 250px;#} word-wrap: break-word; /* 允许单词断开换行 */
        }

        .copyButton, .editButton {
            display: block;
            margin-bottom: 10px; /* 设置底部间距 */
        }

    </style>
{% endblock %}
