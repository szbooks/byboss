{% extends 'layout/base.html' %}

{% block content %}
    <div class="content-area">
        <!-- 顶部操作栏 -->
        <div class="d-flex align-items-center flex-wrap mb-3">
            <!-- 操作按钮 -->
            <a href="{{ url_for('main.add_coop_ex') }}" class="btn btn-primary me-2 mb-2">添加合作伙伴</a>
            <!-- 查询表单 -->
            <form action="{{ url_for('main.coop_ex') }}" method="get" class="d-flex align-items-center mb-2 flex-grow-0">
                <input type="text" class="input-group-text me-2" name="partner" placeholder="合作伙伴" value="{{ request.args.get('partner', '') }}">
                <input type="text" class="input-group-text me-2" name="code" placeholder="邀请码" value="{{ request.args.get('code', '') }}">
                <select class="form-select me-2" name="status" id="status">
                    <option value="">是否授权</option>
                    <option value="1" {% if status_filter == '1' %}selected{% endif %}>是</option>
                    <option value="0" {% if status_filter == '0' %}selected{% endif %}>否</option>
                </select>
                <button type="submit" class="btn btn-outline-primary">查询</button>
            </form>

        </div>
        <table class="table table-striped table-bordered table-light table-hover">
            <thead>
            <tr>
                <th>开放</th>
                <th>合作伙伴</th>
                <th>联系方式</th>
                <th>微信id</th>
                <th>合作区域</th>
                <th>推广邀请码</th>
                <th>邀请数/已赠送数</th>
                <th>邀请公司</th>
                <th>未付费</th>
                <th>异常（已支付未赠送）</th>
                <th>获得推广费/总付费</th>
                <th>手动邀请</th>
                <th>优惠策略</th>
                <th>备注</th>
                <th>创建时间</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            {% for result  in results %}
                <tr data-id="{{ result.id }}">
                    <td>
                        <div class="form-check form-switch">
                            <span><input class="form-check-input" type="checkbox" role="switch" id="statusCheckbox_{{ result.id }}" {{ 'checked' if result.isauthority == "1" else '' }}></span>
                        </div>
                    </td>
                    <td>{% if result.name %}{{ result.name }}{% else %}{{ "" }}{% endif %}</td>

                    <td><span class="wrap-ellipsis">{% if result.phone %}{{ result.phone }}{% else %}{{ "" }}{% endif %}</span>
                        {#                        <span class="wrap-ellipsis" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ receipt.todo_remark }}">{{ receipt.todo_remark|default('', true) }}</span>#}
                    </td>

                    <td style="max-width: 90px;"><span class="wrap-ellipsis">{% if result.wx_id %}{{ result.wx_id }}{% else %}{{ "" }}{% endif %}</span></td>

                    <td>
                        <span class="show-more" style="cursor: pointer;">
                            <span class="wrap-ellipsis" data-full-content="{{ result.area }}" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ result.area }}">{% if result.area %}
                                {{ result.area }}{% else %}{{ "" }}{% endif %}</span>
                        </span>
                    </td>
                    <td>{% if result.code %}{{ result.code }}{% else %}{{ "" }}{% endif %}</td>
                    {#                    <td style="max-width: 50px;">{% if result.num %}{{ result.num }}{% else %}{{ 0 }}{% endif %}/{% if result.pay_num %}{{ result.pay_num }}{% else %}{{ 0 }}{% endif %}</td>#}

                    <td style="max-width: 50px;">
                        <span class="show-more" style="cursor: pointer;">
                            <span class="wrap-ellipsis" data-id="{{ result.id }}" data-field="num">loading</span> <!-- Unicode for "Loading" icon -->
                            <span class="glyphicon glyphicon-triangle-bottom"></span>
                        </span>
                    </td>


                    <!-- ... 其他HTML代码 ... -->
                    <td style="max-width: 150px; position: relative;">
                        <span class="show-more" style="cursor: pointer;">
                            <span class="wrap-ellipsis" data-id="{{ result.id }}" data-field="companys" title="点击可复制">loading</span> <!-- Unicode for "Loading" icon -->
                            <span class="glyphicon glyphicon-triangle-bottom"></span>
                        </span>
                    </td>
                    <td style="max-width: 150px; position: relative;">
                        <span class="show-more" style="cursor: pointer;">
                            <span class="wrap-ellipsis" data-id="{{ result.id }}" data-field="unpay" title="点击可复制">loading</span> <!-- Unicode for "Loading" icon -->
                            <span class="glyphicon glyphicon-triangle-bottom"></span>
                        </span>
                    </td>
                    <td style="max-width: 150px;>
                        <span class="show-more" style="cursor: pointer;">
                            <span class="wrap-ellipsis" data-id="{{ result.id }}" data-field="ungive" title="点击可复制">loading</span> <!-- Unicode for "Loading" icon -->
                            <span class="glyphicon glyphicon-triangle-bottom"></span>
                        </span>
                    </td>

                    <td>
                        <span class="show-more" style="cursor: pointer;">
                            <span class="wrap-ellipsis" data-id="{{ result.id }}" data-field="fee">loading</span> <!-- Unicode for "Loading" icon -->
                            <span class="glyphicon glyphicon-triangle-bottom"></span>
                        </span>
                    </td>

                    <td style="max-width: 150px; position: relative;">
                        <span class="show-more" style="cursor: pointer;">
                            <span class="wrap-ellipsis" data-field="add_company" data-bs-toggle="tooltip" data-bs-placement="top" data-full-content="{{ result.add_company }}"
                                  title="{{ result.add_company }}">{{ result.add_company|default('', true) }}</span> <!-- Unicode for "Loading" icon -->
                            <span class="glyphicon glyphicon-triangle-bottom"></span>
                        </span>
                    </td>

                    <td>
                        <span class="show-more_no" style="cursor: pointer;">
                            <span class="wrap-ellipsis" data-field="discounts" data-bs-toggle="tooltip" data-bs-placement="top"
                                  title="{{ result.discounts }}">{{ result.discounts|default('', true) }}</span> <!-- Unicode for "Loading" icon -->
                            <span class="glyphicon glyphicon-triangle-bottom"></span>
                        </span>
                    </td>


                    <td>
                        <span class="show-more_no" style="cursor: pointer;">
                            <span class="wrap-ellipsis" data-full-content="{{ result.remark }}" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ result.remark }}">{% if result.remark %}
                                {{ result.remark }}{% else %}{{ "" }}{% endif %}</span>
                        </span>
                    </td>

                    <td>{% if result.create_date %}{{ result.create_date }}{% else %}{{ "" }}{% endif %}</td>
                    <td style="width: 80px">
                        <a href="{{ url_for('main.do_coop_ex', id=result.id) }}" class="text-link">编辑</a><br>
                        <a href="{{ url_for('main.add_company_coop_ex', id=result.id) }}" class="text-link">添加公司</a>
                    </td>

                </tr>
            {% endfor %}
            </tbody>
        </table>
        <!-- 底部分页控件 -->
        <nav aria-label="Page navigation" class="d-flex justify-content-end pagination-container">
            <ul class="pagination pagination-sm">
                <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.coop_ex', page=page-1) }}">上一页</a>
                </li>
                {% for num in range(1, total_pages + 1) %}
                    <li class="page-item {% if num == page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('main.coop_ex', page=num) }}">{{ num }}</a>
                    </li>
                {% endfor %}
                <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.coop_ex', page=page+1) }}">下一页</a>
                </li>
            </ul>
        </nav>
    </div>

    <script>

        document.addEventListener('DOMContentLoaded', function () {


            // 异步获取数据
            fetch('/coop_ex_updata', {
                method: 'GET', // 或者GET，取决于你的API
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data);

                    // 假设data是一个对象，键是ID，值是{companys: ..., unpay: ...}
                    data.forEach(item => {
                        var row = document.querySelector(`tr[data-id="${item.id}"]`); // 假设你为每个tr添加了一个data-id属性
                        {#console.log(row);#}
                        {#console.log(item.id);#}
                        if (row) {
                            var companysCell = row.querySelector(`.wrap-ellipsis[data-id="${item.id}"][data-field="companys"]`);
                            var unpayCell = row.querySelector(`.wrap-ellipsis[data-id="${item.id}"][data-field="unpay"]`);
                            var ungiveCell = row.querySelector(`.wrap-ellipsis[data-id="${item.id}"][data-field="ungive"]`);
                            var feeCell = row.querySelector(`.wrap-ellipsis[data-id="${item.id}"][data-field="fee"]`);
                            var numCell = row.querySelector(`.wrap-ellipsis[data-id="${item.id}"][data-field="num"]`);
                            {#console.log(companysCell);#}
                            if (companysCell) {
                                companysCell.textContent = item.companys || '';
                                companysCell.title = '点击可复制 ';
                                companysCell.dataset.fullContent = item.companys || ''; // 添加 data-full-content
                            }

                            if (unpayCell) {
                                if (item.unpay && item.add_company_unpay) {
                                    unpayCell.textContent = item.unpay + "," + item.add_company_unpay;
                                    unpayCell.dataset.fullContent = item.unpay + "," + item.add_company_unpay;
                                } else if (!item.unpay && item.add_company_unpay) {
                                    unpayCell.textContent = item.add_company_unpay;
                                    unpayCell.dataset.fullContent = item.add_company_unpay;
                                } else if (item.unpay && !item.add_company_unpay) {
                                    unpayCell.textContent = item.unpay;
                                    unpayCell.dataset.fullContent = item.unpay;
                                } else {
                                    // 如果两者都不存在，可以设置为空字符串或其他默认值
                                    unpayCell.textContent = '';
                                    unpayCell.dataset.fullContent = '';
                                }
                                {#unpayCell.textContent = item.unpay + "," + item.add_company_unpay || '';#}
                                unpayCell.title = '点击可复制 ';
                                {#unpayCell.dataset.fullContent = item.unpay + "," + item.add_company_unpay || ''; // 添加 data-full-content#}
                            }

                            if (ungiveCell) {
                                ungiveCell.textContent = item.ungive || '';
                                ungiveCell.title = '点击可复制 ';
                                ungiveCell.dataset.fullContent = item.ungive || ''; // 添加 data-full-content
                            }

                            if (feeCell) {
                                // 拼接 promotion_fee 和 original_price
                                var promotionFee = item.promotion_fee === null ? '0' : item.promotion_fee || '0';
                                var originalPrice = item.original_price === null ? '0' : item.original_price || '0';

                                // 如果两者都是 undefined，则显示为空字符串
                                if (promotionFee === '' && originalPrice === '') {
                                    promotionFee = '';
                                    originalPrice = '';
                                }

                                var displayValue = `${promotionFee}/${originalPrice}`;

                                feeCell.textContent = displayValue;


                            }
                            if (numCell) {
                                // 拼接 promotion_fee 和 original_price
                                var num = item.num === null ? '0' : item.num || '0';
                                var pay_num = item.pay_num === null ? '0' : item.pay_num || '0';

                                // 如果两者都是 undefined，则显示为空字符串
                                if (num === '' && pay_num === '') {
                                    num = '';
                                    pay_num = '';
                                    var displayValue = ``;
                                } else {
                                    var displayValue = `${num}/${pay_num}`;
                                }


                                numCell.textContent = displayValue;


                            }
                        }
                    });

                    // 初始化Tooltip（如果你使用的是Bootstrap Tooltip）
                    // 注意：如果Tooltip是动态添加的，你可能需要在数据加载后重新初始化它们
                    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
                        new bootstrap.Tooltip(tooltipTriggerEl);
                    });

                    // 绑定展开/收起事件
                    bindExpandCollapseEvents();
                })
                .catch(error => console.error('Error fetching data:', error));

            // 绑定展开/收起事件的函数
            function bindExpandCollapseEvents() {
                document.querySelectorAll('.show-more').forEach(function (showMoreEl) {
                    showMoreEl.addEventListener('click', function () {
                        var $this = this;
                        var $content = $this.querySelector('.wrap-ellipsis');
                        var fullContent = $content.title;


                    });
                });
            }


            //checkbox
            {#        const checkboxes = document.querySelectorAll('.form-check-input');#}
            {##}
            {#checkboxes.forEach(checkbox => {#}
            {#    const id = checkbox.closest('tr').getAttribute('data-id');#}
            {#    const result = data.results.find(item => item.id === parseInt(id));#}
            {##}
            {#    if (result.isauthority === 1) {#}
            {#        checkbox.checked = true;#}
            {#    }#}
            checkbox.addEventListener('change', function () {
                const id = this.closest('tr').getAttribute('data-id');
                const isChecked = this.checked;

                // 发送 AJAX 请求到后端
                fetch(`/update_authority/${id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({status: isChecked})
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Status updated successfully:', data);
                        // 在这里可以处理返回的数据，例如显示成功消息等
                    })
                    .catch(error => {
                        console.error('Failed to update status:', error);
                        // 在这里可以处理错误情况，例如显示错误消息等
                    });
            });

        });


        $('.show-more').click(function (e) {
            e.preventDefault(); // 阻止默认点击行为

            // 找到包含完整内容的span元素
            var fullContentSpan = $(this).find('.wrap-ellipsis');

            // 从data-full-content属性中获取完整内容
            var textToCopy = fullContentSpan.data('full-content');

            // 创建一个临时的textarea元素来复制文本
            var textarea = document.createElement("textarea");
            textarea.value = textToCopy;
            document.body.appendChild(textarea);
            textarea.select();

            // 尝试复制文本到剪贴板
            try {
                var successful = document.execCommand('copy');
                var msg = successful ? '成功' : '失败';
                console.log('文本复制: ' + msg);
                showCopySuccessToast();
                // 可选：显示一些用户反馈
                {#alert('内容已复制!');#}{##}
            } catch (err) {
                console.error('复制文本时出错:', err);
                alert('复制失败，请尝试手动复制。');
            }

            // 移除临时的textarea元素
            document.body.removeChild(textarea);
        });

        function showCopySuccessToast() {
            var toastDiv = document.createElement('div');
            toastDiv.textContent = '数据已复制到剪贴板';
            toastDiv.style.position = 'fixed';
            toastDiv.style.top = '10%';
            toastDiv.style.left = '50%';
            toastDiv.style.transform = 'translateX(-50%)';
            toastDiv.style.backgroundColor = '#f8d7da';
            toastDiv.style.color = '#721c24';
            toastDiv.style.padding = '10px';
            toastDiv.style.borderRadius = '5px';
            toastDiv.style.zIndex = '1000';
            toastDiv.style.minWidth = '250px';
            toastDiv.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
            document.body.appendChild(toastDiv);

            // 移除提示信息
            setTimeout(function () {
                document.body.removeChild(toastDiv);
            }, 2000);
        }

        document.addEventListener('DOMContentLoaded', function () {
            const checkboxes = document.querySelectorAll('.form-check-input');

            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    const id = this.closest('tr').getAttribute('data-id');
                    const isChecked = this.checked;

                    // 发送 AJAX 请求到后端
                    fetch(`/update_authority/${id}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({status: isChecked})
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('Status updated successfully:', data);
                            // 在这里可以处理返回的数据，例如显示成功消息等
                        })
                        .catch(error => {
                            console.error('Failed to update status:', error);
                            // 在这里可以处理错误情况，例如显示错误消息等
                        });
                });
            });
        });

    </script>

    <style>


        /* 自定义单元格样式 */
        .wrap-ellipsis {
            display: -webkit-box;
            -webkit-line-clamp: 5; /* 显示的最大行数 */
            -webkit-box-orient: vertical;
            overflow: hidden;
        {#max-width: 250px;#} word-wrap: break-word; /* 允许单词断开换行 */
        }

        .full-content {
            display: none;
            position: absolute;
            top: 100%; /* 根据需要调整 */
            left: 0;
            background-color: white;
            border: 1px solid #ccc;
            z-index: 1000; /* 确保内容在顶部 */
            max-width: 400px;
            min-height: 200px;

            /* 其他样式，如宽度、边框、阴影等 */
        }


    </style>
{% endblock %}
