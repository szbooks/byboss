{% extends 'layout/base.html' %}


{% block content %}
    <div class="container">
    <!-- 顶部操作栏 -->
    <div class="d-flex align-items-center flex-wrap mb-3">
        <!-- 查询表单 -->

        <form id="company-form" action="{{ url_for('main.presales_followup') }}" method="get" class="d-flex align-items-center mb-2 flex-grow-0">
            {#    <div class="row">#}
            <input type="text" class="input-group-text me-2" name="company_id" placeholder="输入公司ID" value="{{ request.args.get('company_id', '') }}">

            <select class="form-select me-2" name="account_status" id="account_status">
                    <option value=''>账号状态</option>
                    <option value="5" {% if status_filter['account_status'] == '5' %}selected{% endif %}>未激活</option>
                    <option value="1" {% if status_filter['account_status'] == '1' %}selected{% endif %}>试用期</option>
                    <option value="2" {% if status_filter['account_status'] == '2' %}selected{% endif %}>已付费</option>
                    <option value="3" {% if status_filter['account_status'] == '3' %}selected{% endif %}>保号期</option>
                    <option value="4" {% if status_filter['account_status'] == '4' %}selected{% endif %}>冻结期</option>
            </select>
            <!-- Move the button inside the input group -->
            <button type="submit" class="btn btn-outline-primary fixed-width-btn">查询</button>

        </form>


        <div class="col-md-12">
            <p>记录总数: {{ total_count }}</p>
        </div>


        <table id="company-table" class="table table-striped table-bordered table-light table-hover">
            <thead>
            <tr>
                <th>公司ID</th>
                <th>房号数</th>
                <th>到期日</th>
                <th>账号状态</th><!-- 试用期，已付费，保号期，冻结期，紧急延期 -->
                <th>售前专属跟进人</th>
                <th>客服跟进</th>
                <th>民宿基本情况（售前）</th>
                <th>试用期目标（售前）</th>
                <th>目标完成情况（客服）</th>
                <th>跟进说明（客服）</th>
                <th>备注</th>
                <th>状态</th>
                <th>任务更新日期</th>
                <th>跟进更新日期</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            {% for company  in results %}
                <tr>
                    <td>{% if company.company_id %}{{ company.company_id }}{% else %}{{ "" }}{% endif %}</td>
                    <td>{% if company.room_count %}{{ company.room_count }}{% else %}{{ 0 }}{% endif %}</td>
                    <td>{% if company.end_data %}{{ company.end_data }}{% else %}{{ "" }}{% endif %}</td>
                     <td>
                        {% if company.account_state == '1' %}
                            <span class="status-pending">试用期</span>
                        {% elif company.account_state == '2' %}
                            已付费
                        {% elif company.account_state == '3' %}
                            保号期
                        {% elif company.account_state == '4' %}
                            冻结期
                        {% elif company.account_state == '5' %}
                            未激活
                        {% else %}
                            {{ "" }}
                        {% endif %}
                    </td>
                    <td>{% if company.presales %}{{ company.presales }}{% else %}{{ "" }}{% endif %}</td>
                    <td>{% if company.customer %}{{ company.customer }}{% else %}{{ "" }}{% endif %}</td>
                    <td style="text-align:left;">
                        <div id="basic-info-{{ loop.index }}">
                            {% if company.basic_info %}

                                <script>
                                    // 获取公司的基本信息 JSON 字符串
                                    var basicInfoJson = '{{ company.basic_info }}';

                                    // 将 JSON 字符串中的转义字符替换为双引号
                                    var jsonStringWithQuotes = basicInfoJson.replace(/&#34;/g, '"');

                                    // 解析 JSON 字符串为 JavaScript 对象
                                    var basicInfo = JSON.parse(jsonStringWithQuotes);

                                    // 映射对象，用于将键替换为特定的字符串
                                    var keyMapping = {
                                        "input_ispms": "用过PMS",
                                        "input_direct": "直连平台",
                                        "input_syn": "房态同步",
                                        "input_reception": "前台",
                                        "input_checkin": "入住",
                                        "input_deposit": "押金",
                                        "input_cleaning": "保洁",
                                        "input_price": "改价",
                                        "input_chat": "聊天",
                                        "input_evaluate": "评价",
                                        "input_recustomer": "回头客",
                                        "input_einvestor": "投资人",
                                        "input_finance": "财务",
                                        // 其他键值对
                                    };
                                    var period_keyMapping = {
                                        "input_check1": "直连",
                                        "input_check2": "房态",
                                        "input_check3": "入住",
                                        "input_check4": "保洁",
                                        "input_optional_check1": "直连1",
                                        "input_optional_check2": "房态1",
                                        "input_optional_check3": "入住1",
                                        "input_optional_check4": "保洁1",
                                    };

                                    // 构建基本信息的 HTML 字符串
                                    var basicInfoHtml = '';
                                    for (var key in basicInfo) {
                                        if (basicInfo[key] !== '') {  // 检查值是否为空
                                            var replacedKey = keyMapping[key] || key;  // 使用映射对象进行替换，如果没有映射则使用原始键
                                            basicInfoHtml += '<div><b style="text-align:left;">' + replacedKey + ':</b> ' + basicInfo[key] + '</div>';
                                        }
                                    }

                                    // 将 HTML 字符串放入相应的元素中
                                    document.getElementById('basic-info-{{ loop.index }}').innerHTML = basicInfoHtml;
                                </script>
                            {% endif %}
                        </div>


                    </td>
                    <td style="text-align:left;">
                        <div id="period_target-{{ company.company_id }}">
                            <div id="check-{{ company.company_id }}">必选</div>
                            <div id="optional_check-{{ company.company_id }}">可选</div>
                        </div>
                        <script>
                            var period_targetJson = '{{ company.period_target }}';

                            var period_targetJsontra = period_targetJson.replace(/&#34;/g, '"');

                            var period_target = JSON.parse(period_targetJsontra);

                            var checkDiv = document.getElementById("check-{{ company.company_id }}");
                            var optionalCheckDiv = document.getElementById("optional_check-{{ company.company_id }}");

                            for (var key in period_target) {
                                var value = period_target[key];
                                if (value !== "") {
                                    var mappedKey = period_keyMapping[key] || key;
                                    if (["input_check1", "input_check2", "input_check3", "input_check4"].includes(key)) {
                                        checkDiv.innerHTML += "<div><b>" + mappedKey + ":</b> " + value + "</div>";
                                    } else if (["input_optional_check1", "input_optional_check2", "input_optional_check3", "input_optional_check4"].includes(key)) {
                                        optionalCheckDiv.innerHTML += "<div><b>" + mappedKey + ":</b> " + value + "</div>";
                                    }
                                }
                            }
                        </script>


                    </td>
                    <td style="text-align:left;">
                        <div id="progress_exec-{{ company.company_id }}">
                            <div id="progress_exec_check-{{ company.company_id }}">必选</div>
                            <div id="progress_exec_optional_check-{{ company.company_id }}">可选</div>
                            <script>
                                var progress_execJson = '{{ company.progress_exec }}';

                                // 将 JSON 字符串中的转义字符替换为双引号
                                var progress_execJsontra = progress_execJson.replace(/&#34;/g, '"');

                                // 解析 JSON 字符串为 JavaScript 对象
                                var progress_exec = JSON.parse(progress_execJsontra);


                                var checkDiv = document.getElementById("progress_exec_check-{{ company.company_id }}");
                                var optionalCheckDiv = document.getElementById("progress_exec_optional_check-{{ company.company_id }}");

                                for (var key in progress_exec) {
                                    var value = progress_exec[key];
                                    if (value !== "") {
                                        var mappedKey = period_keyMapping[key] || key; // 使用映射表中的替代键，如果不存在则保持原样
                                        if (["input_check1", "input_check2", "input_check3", "input_check4"].includes(key)) {
                                            checkDiv.innerHTML += "<div><b>" + mappedKey + ":</b> " + value + "</div>";
                                        } else if (["input_optional_check1", "input_optional_check2", "input_optional_check3", "input_optional_check4"].includes(key)) {
                                            optionalCheckDiv.innerHTML += "<div><b>" + mappedKey + ":</b> " + value + "</div>";
                                        }
                                    }
                                }
                            </script>
                    </td>
                    <td>{% if company.progress_description %}{{ company.progress_description }}{% else %}{{ "" }}{% endif %}</td>
                    <td>{% if company.progress_remark %}{{ company.progress_remark }}{% else %}{{ "" }}{% endif %}</td>
                    <td>{% if company.state %}{{ company.state }}{% else %}{{ "" }}{% endif %}</td>
                    <td>{% if company.submit_time %}{{ company.submit_time }}{% else %}{{ "" }}{% endif %}</td>
                    <td>{% if company.progress_data %}{{ company.progress_data }}{% else %}{{ "" }}{% endif %}</td>


                    <td>
                        <a href="#" class="open-modal" data-company-id="{{ company.company_id }}">目标设置</a>
                        <a href="#" class="progress-modal" data-bs-toggle="modal" data-bs-target="#progressModal{{ company.company_id }}" data-company-id="{{ company.company_id }}">跟进说明</a>


                        <!-- Remarks Modal -->
                        <div class="modal fade" id="remarksModal{{ company.company_id }}" tabindex="-1" aria-labelledby="remarksModalLabel{{ company.company_id }}" aria-hidden="true">
                            <div class="modal-dialog modal-xl" style="height: 200px;"> <!-- or modal-xl -->
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="remarksModalLabel{{ company.company_id }}">目标完成情况设置({{ company.company_id }})</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <!-- Remarks form -->
                                        <form id="remarksForm{{ company.company_id }}" action="{{ url_for('main.save_progress_exec') }}" method="post" class="mb-2"
                                              data-company-id="{{ company.company_id }}">


                                            <div class="container-fluid">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <p class="text-start" style="margin: 10px;"><b>必选项</b></p>
                                                        <div class="select-left" id="generatedInputLeft-{{ company.company_id }}">


                                                        </div>
                                                    </div>


                                                    <div class="col-md-6">
                                                        <p class="text-start" style="margin: 10px;"><b>可选项</b></p>
                                                        <div class="select-right" id="generatedInputRight-{{ company.company_id }}">


                                                        </div>
                                                    </div>

                                                </div>
                                            </div>
                                            <div class="row mt-3 justify-content-center"></div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                                <button type="submit" id="progresssubmit{{ company.company_id }}" class="btn btn-primary" data-company-id="{{ company.company_id }}">保存备注</button>
                                            </div>

                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 跟进说明Modal -->
                        <div class="modal fade" id="progressModal{{ company.company_id }}" tabindex="-1" aria-labelledby="exprogressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <form id="progressForm{{ company.company_id }}" action="{{ url_for('main.save_progress_description') }}" method="post" class="mb-2" data-company-id="{{ company.company_id }}">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">跟进说明及备注({{ company.company_id }})</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group">
                        <div><label for="progress_description">跟进说明</label></div>
                        <textarea class="form-control" id="progress_description{{ company.company_id }}" name="progress_description" aria-label="With textarea" style="margin-top: 10px; margin-bottom: 50px; height: 250px; width: 600px;"></textarea>
                    </div>
                    <div class="input-group">
                        <div><label>备注说明</label></div>
                        <textarea class="form-control" id="progress_remark{{ company.company_id }}" aria-label="With textarea" name="progress_remark" style="margin-top: 10px; margin-bottom: 50px; height: 250px;width:600px;"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
</div>

                    </td>

                </tr>
            {% endfor %}
            </tbody>
        </table>
        <div class="modal fade" id="loadingModal" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="loadingModalLabel">处理中......</h5>
                    </div>
                    <div class="modal-body">
                        <!-- 加载动画内容，这里可以使用第三方库或者自定义的加载动画 -->
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 底部分页控件 -->
        <nav aria-label="Page navigation">
            <ul class="pagination">
                {% for page in page_numbers %}
                    {% if page == '...' %}
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% else %}
                        <li class="page-item {% if page == current_page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('main.unpay_companies', page=page) }}">{{ page }}</a>
                        </li>
                    {% endif %}
                {% endfor %}
            </ul>
        </nav>


    </div>
    <script>
        var currentPage;
        var currentCompanyId;  // 新增的变量

        $(document).ready(function () {
            $('#progressModal').modal();
            $('.open-modal').click(function () {

                currentPage = "{{ current_page }}";
                currentCompanyId = $(this).data('company-id');  // 存储 companyId
                console.log("currentCompanyId", currentCompanyId);
                var companyId = currentCompanyId;
                // Fetch existing data via AJAX and populate the modal
                $('#generatedInputLeft-' + companyId).empty();
                $('#generatedInputRight-' + companyId).empty();

                $.ajax({
                    url: "{{ url_for('main.get_progress_exec', company_id='')}}" + companyId,
                    type: 'GET',
                    success: function (data) {
                        // Check if data.remarks is not empty
                        console.log('companyId:', companyId);
                        console.log('data.period_target:', data.period_target);
                        var period_targetc = JSON.parse(data.period_target);

                        console.log('data.period_targetc:', period_targetc);
                        var progress_exec_value = "";
                        if (data.period_target) {
                            for (var key in period_targetc) {
                                var value = period_targetc[key];
                                if (value !== "") {
                                    var mappedKey = period_keyMapping[key] || key; // 使用映射表中的替代键，如果不存在则保持原样
                                    mappedKey = mappedKey = mappedKey + ': ' + value;
                                    if (data.progress_exec) {
                                        var progress_exec = JSON.parse(data.progress_exec);
                                        console.log('data.progress_exec:', data.progress_exec);
                                        for (var progress_exec_key in progress_exec) {
                                            if (progress_exec_key === key) {
                                                progress_exec_value = progress_exec[key];
                                                break;
                                            }
                                        }
                                        if (["input_check1", "input_check2", "input_check3", "input_check4"].includes(key)) {
                                            generateInputBox(mappedKey, document.getElementById('generatedInputLeft-' + companyId), 'custom-container', key, progress_exec_value);
                                        } else if (["input_optional_check1", "input_optional_check2", "input_optional_check3", "input_optional_check4"].includes(key)) {
                                            generateInputBox(mappedKey, document.getElementById('generatedInputRight-' + companyId), 'custom-container', key, progress_exec_value);
                                        }
                                    } else {
                                        if (["input_check1", "input_check2", "input_check3", "input_check4"].includes(key)) {
                                            generateInputBox(mappedKey, document.getElementById('generatedInputLeft-' + companyId), 'custom-container', key, progress_exec_value);
                                        } else if (["input_optional_check1", "input_optional_check2", "input_optional_check3", "input_optional_check4"].includes(key)) {
                                            generateInputBox(mappedKey, document.getElementById('generatedInputRight-' + companyId), 'custom-container', key, progress_exec_value);
                                        }
                                    }
                                }
                                // Populate other fields if needed
                            }
                        }
                    }
                });

                // Set the company_id input value before serializing the form data

                $('#remarksModal' + companyId).modal('show');

            });

            // 表单提交事件在外部处理
            $('form[id^="remarksForm"]').submit(function (e) {
                var companyId = $(this).data('company-id');

                // Include the current page number in the form data
                $('#remarksModal' + currentCompanyId).modal('hide');
                var formData = {};
                $(this).find('select').each(function () {
                    formData[$(this).attr('name')] = $(this).val();
                });

                // 添加其他需要提交的表单数据
                formData['company_id'] = companyId;
                formData['current_page'] = currentPage;
                $('#loadingModal').modal('show');
                // AJAX request to save company remarks
                console.log(formData);
                $.ajax({
                    url: "/save_progress_exec",
                    type: 'POST',
                    data: formData,  // Serialize the form data

                    success: function (response) {
                        // Handle the success response if needed
                        console.log(response);
                        $('#remarksModal' + currentCompanyId).modal('hide');  // 使用 currentCompanyId
                        // Hide loading spinner or modal when the request is complete

                        location.reload();
                        setTimeout(function () {
                            $('#loadingModal').modal('hide');
                        }, 3000);
                        {#$('#loadingModal').modal('hide');#}
                        // Display success message
                        // alert('处理成功');
                    },
                    error: function (error) {
                        // Handle the error response if needed
                        console.error(error);

                        // Hide loading spinner or modal on error
                        $('#loadingModal').modal('hide');
                        $('#remarksModal' + currentCompanyId).modal('hide');  // 使用 currentCompanyId

                        // Display an error message
                        alert('处理失败');
                    }
                });
                // Prevent the default form submission
                e.preventDefault();
            });
        });


        $('.progress-modal').click(function () {
            currentCompanyId = $(this).data('company-id');
            var companyId = $(this).data('company-id');


            document.getElementById("progress_description"+currentCompanyId).value = "";


                $.ajax({
    url: "{{ url_for('main.get_progress_exec', company_id='') }}" + currentCompanyId,
    type: 'GET',
    success: function (data) {
        // 将progress_description和progress_remark填充到textarea中
         $('#progress_description' + currentCompanyId).val(data.progress_description);
         $('#progress_remark' + currentCompanyId).val(data.progress_remark);
    }
});
            $('#progressModal' + companyId).modal('show');
        });


        $('form[id^="progressForm"]').submit(function (e) {
            // Prevent the default form submission
            e.preventDefault();
            $('#progressModal' + currentCompanyId).modal('hide');
            // Get the company_id from data attribute
            var companyId = $(this).data('company-id');

            // Show the loading modal
            $('#loadingModal').modal('show');

            // Serialize the form data
            var formData = $(this).serializeArray();

            // Add company_id to form data
            formData.push({name: 'company_id', value: companyId});

            // Submit the form using AJAX
            $.ajax({
                {#url: $(this).attr('action'),#}
                url: "/save_progress_description",
                type: 'POST',
                data: formData,
                success: function (response) {

                    $('#progressForm' + companyId).modal('hide');
                    location.reload();
                    // Hide the loading modal on success
                    $('#loadingModal').modal('hide');
                    // Other actions...
                },
                error: function (error) {
                    console.error(error);
                    // Hide the loading modal on error
                    $('#loadingModal').modal('hide');
                    $('#progressForm' + companyId).modal('hide');
                    // Other actions...
                }
            });
        });


        function generateInputBox(labelName, container, customClass, key, selectedValue) {
            // 创建包含输入框和标签的容器

            var containerDiv = document.createElement('div');
            containerDiv.setAttribute('class', 'input-group mb-3 ' + customClass); // 添加额外的自定义类// 添加额外的类custom-container


            // 创建标签元素
            var label = document.createElement('label');
            label.setAttribute('class', 'input-group-text custom-label');
            label.setAttribute('style', 'width: 400px;');
            label.setAttribute('for', 'inputGroupSelect01');
            label.textContent = labelName; // 设置标签的文本内容

            // 创建选择框元素
            var select = document.createElement('select');
            select.setAttribute('class', 'form-select');
            select.setAttribute('id', 'inputGroupSelect01');
            select.setAttribute('name', key)


            // 添加默认选项
            var defaultOption = document.createElement('option');
            defaultOption.setAttribute('selected', '');
            defaultOption.textContent = '未开始';
            select.appendChild(defaultOption);

            // 添加其他选项（这里示例添加两个选项）
            var option1 = document.createElement('option');
            option1.textContent = "进行中";
            select.appendChild(option1);

            var option2 = document.createElement('option');
            option2.textContent = "已完成";
            select.appendChild(option2);

            if (selectedValue === "进行中") {
                option1.setAttribute('selected', 'true');
            } else if (selectedValue === "已完成") {
                option2.setAttribute('selected', 'true');
            } else {
                defaultOption.setAttribute('selected', 'true');
            }

            // 将标签和选择框添加到容器中
            containerDiv.appendChild(label);
            containerDiv.appendChild(select);

            // 将容器添加到指定的父容器中
            container.appendChild(containerDiv);
        }


    </script>

    <style>
        .input-group. label {
            display: block; /* 将 label 设置为块级元素，使其单独占据一行 */
            margin-bottom: 10px; /* 设置 label 与 textarea 之间的间距 */
        }


        /* 自定义 modal-footer 样式 */
        .modal-footer {
            display: flex;
            justify-content: flex-end; /* 将按钮放置在弹性布局中并右对齐 */
        }

        /* 自定义 modal-footer 中按钮的样式 */
        .modal-footer .btn {
            width: 120px; /* 设置按钮的宽度 */
            height: 40px; /* 设置按钮的高度 */
            margin-left: 10px; /* 设置按钮之间的左侧间距 */
            font-size: 16px; /* 调整按钮文字大小 */
        }

        /* 调整取消按钮的右侧间距 */
        .modal-footer .btn-secondary {
            margin-right: 10px;
        }

        .custom-container {
            width: 500px;
            margin: 10px;
        }

        /* 添加任何其他样式 */
        #}


        .input-group-text {
            width: 120px; /* Set your desired width */
            height: 50px;
        }

        .form-select {
            width: 500px; /* Set your desired width for the input */
            height: 50px;
            /* Add any additional styling if needed */
        }

        .largeText {
            font-size: 15px;
            display: flex;
            align-items: center; /* 垂直居中对齐 */
            justify-content: center; /* 水平居中对齐 */
            height: 100%; /* 让高度占满父容器 */
            margin: 0; /* 移除可能存在的外边距 */
        }

        .col-md-6 {
            border: 1px solid #ced4da; /* 设置边框样式 */
            border-radius: 0.25rem; /* 设置边框圆角 */
            padding: 0.5rem 0; /* 设置内边距 */
        }


    </style>

{% endblock %}
