{% extends 'layout/base.html' %}

{% block content %}
    <div class="container">
        <!-- 顶部操作栏 -->
        <div class="d-flex align-items-center flex-wrap mb-3">
            <!-- 查询表单 -->
            <form action="{{ url_for('main.companies') }}" method="get" class="d-flex align-items-center mb-2 flex-grow-0">
                <select class="form-select me-2" name="status" id="status">
                    <option value="">所有状态</option>
                    <option value="1" {% if status_filter == '1' %}selected{% endif %}>待处理</option>
                    <option value="2" {% if status_filter == '2' %}selected{% endif %}>已完成</option>
                    <option value="3" {% if status_filter == '3' %}selected{% endif %}>已拒绝</option>
                </select>
                <button type="submit" class="btn btn-outline-primary">查询</button>
            </form>
        </div>
        <table id="company-table" class="table table-striped table-bordered table-light table-hover">
            <thead>
                <tr>
                    <th data-column="company_id" data-orderable="false">公司ID</th>
                    <th data-column="company_name" data-orderable="false">公司名称</th>
                    <th data-column="account_state" data-orderable="false">账号状态</th>
                    <th data-column="registration_date">注册1日</th>
                    <th data-column="end_data" data-orderable="false">到期日</th>
                    <th data-column="registrant" data-orderable="false">注册人</th>
                    <th data-column="source" data-orderable="false">注册来源</th>
                    <th data-column="room_count" data-orderable="false">房号数</th>
                    <th data-column="platform_count" data-orderable="false">直连平台数</th>
                    <th data-column="platform_count" data-orderable="false">直连账号数</th>
                    <th >员工数</th>
                    <th>付费总金额</th>
                    <th>付费总次数</th>
                    <th>最近付费日</th>
                    <th>功能使用</th><!-- 房态同步，精确库存，入住，保洁，汇聊，房价，微店......-->
                    <th>7日订单数</th>
                    <th>最近登录</th>
                </tr>
            </thead>
            <tbody>
                {% for company in results %}
                    <tr>
                        <td>{{ company.company_id }}</td>
                        <td>{{ company.company_name }}</td>
                        <td>
                            {% if company.account_state == '1' %}
                                <span class="status-pending">试用期</span>
                            {% elif company.account_state == '2' %}
                                已付费
                            {% elif company.account_state == '3' %}
                                保号期
                            {% elif company.account_state == '4' %}
                                冻结期
                            {% elif company.account_state == '5' %}
                                未激活
                            {% else %}
                                未知状态
                            {% endif %}
                        </td>
                        <td>{{ company.registration_date }}</td>
                        <td>{% if company.end_data %}{{ company.end_data }}{% else %}{{ "" }}{% endif %}</td>
                        <td>{% if company.registrant %}{{ company.registrant }}{% else %}{{ "" }}{% endif %}</td>
                        <td>{% if company.source %}{{ company.source }}{% else %}{{ "" }}{% endif %}</td>
                        <!-- ... Other columns ... -->
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        <!-- ... Pagination ... -->
    </div>

    <script>
        $(document).ready(function () {
            // Initialize DataTable with server-side processing
            var dataTable = $('#company-table').DataTable({
                "processing": true,
                "serverSide": true,
                "ajax": {
                    "url": "{{ url_for('main.companies') }}",
                    "type": "GET",
                    "dataSrc": "data",
                    "data": function (d) {
                        // Add additional parameters here if needed
                        d.status = $('#status').val();
                    }
                },
                "columns": [
                    { "data": "company_id" },
                    { "data": "company_name" },
                    { "data": "account_state" },
                    { "data": "registration_date" },
                    { "data": "end_data" },
                    { "data": "registrant" },
                    { "data": "source" },
                    // ... Other columns ...
                ],
                "order": [[3, 'asc']], // Default sorting column (registration_date)
                "searching": false,
                "lengthChange": false,
                "info": false,
                "columnDefs": [
                    {"orderable": false, "targets": [0, 1, 2]}  // Disable sorting for the first three columns
                ],
                "pageLength": 50
            });

            // Add change event listener for status filter
            $('#status').change(function () {
                dataTable.ajax.reload(); // Reload the table when the status filter changes
            });

            $('[data-bs-toggle="tooltip"]').tooltip();
        });
    </script>
{% endblock %}
