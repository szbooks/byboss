{% extends 'layout/base.html' %}

{% block content %}
    <div class="container">
        <!-- 顶部操作栏 -->
        <div class="d-flex align-items-center justify-content-between mb-3">
            <div class="d-flex align-items-center flex-wrap mb-3">
                <form id="company-form" action="{{ url_for('main.contract_search') }}" method="get" class="d-flex align-items-center">
                    <input type="text" class="form-control me-2" name="contract_code" placeholder="输入订单号或sn支付编号" value="{{ request.args.get('contract_code', '') }}">
                    <button type="submit" class="btn btn-outline-primary fixed-width-btn">查询</button>
                </form>
                <button type="button" class="btn btn-outline-primary fixed-width-btn" data-bs-toggle="modal" data-bs-target="#BatchQueryModal">批量查询</button>
            </div>

            <div class="d-flex align-items-center">
                <!-- Button trigger modal -->
                {#            <button type="button" class="btn btn-primary fixed-width-btn me-2" data-bs-toggle="modal" data-bs-target="#exampleModal">#}
                {#                批量查询#}
                {#            </button>#}

                <!-- Modal -->
                <div class="modal fade" id="BatchQueryModal" tabindex="-1" aria-labelledby="BatchQueryModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form id="BatchQueryModalForm" action="{{ url_for('main.contract_search') }}" method="get" class="mb-2">
                                <div class="modal-header">
                                    <h1 class="modal-title fs-5" id="BatchQueryModalLabel">批量查询</h1>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="form-group">
                                                <textarea class="form-control" id="Batch_Query" name="Batch_Query" aria-label="With textarea"
                                                          style="width: 100%;height: 250px;"></textarea>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                    <button type="submit" class="btn btn-primary">查询</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Right-aligned buttons -->
                <div class="btn-group scale-search" role="group" aria-label="Right aligned buttons">
                    <button id="copyButton" class="btn btn-outline-primary fixed-width-btn">一键复制</button>
                </div>
            </div>
        </div>

        <div class="col-md-12">
            <p>记录总数: {{ total_count }}</p>
        </div>
        <table class="table table-striped table-bordered table-light table-hover">
            <thead>

            <tr>
                <th>订单号</th>
                <th>公司id</th>
                <th>渠道</th>
                <th>平台订单id</th>
                <th>租客姓名</th>
                <th>租客手机号码</th>
                <th>房源名称</th>
                <th>房号</th>
                <th>房费</th>
                <th>入住日期</th>
                <th>订单创建时间</th>
                <th>支付信息</th>

            </tr>
            </thead>
            <tbody>
            {% for row in baseresults %}
                <tr>
                    <td>{{ row.id }}</td>
                    {#                    <td>{% if row.user_id %}{{ row.user_id }}{% else %}{{ "" }}{% endif %}</td>#}
                    <td>
                        <a href="https://www.bypms.cn/admin/user/fakelogin?companyId={{ row.company_id }}" target="_blank">
                            {{ row.company_id }}
                        </a>

                    </td>
                    <td>{{ row.channel }}</td>
                    <td>{{ row.channel_order_id }}</td>
                    <td>{% if row.info_realname %}{{ row.info_realname }}{% else %}{{ "" }}{% endif %}</td>
                    <td>{% if row.info_phone %}{{ row.info_phone }}{% else %}{{ "" }}{% endif %}</td>
                    <td>
                        <span class="ellipsis" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ row.unit_name }}">{% if row.unit_name %}{{ row.unit_name }}{% else %}
                            {{ "" }}{% endif %}</span>
                    </td>


                    <td>{{ row.room_no }}</td>
                    <td>{{ row.price }}</td>
                    <td>{{ row.Check_in }}</td>
                    <td>{{ row.create_time }}</td>
                    <td>
                        {% for csxrow in csxresults %}
                            {{ csxrow.out_no }}<br>
                            支付金额：{{ csxrow.trade_amount }}
                            {% if csxrow.refund_amount|trim == "未退押或未退款" or csxrow.refund_amount|trim == "全扣押" %}
                                退款金额：{{ csxrow.refund_amount }}
                            {% else %}
                                退款金额：{{ csxrow.refund_amount }}
                            {% endif %}
                            <br>
                        {% endfor %}


                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        <!-- 底部分页控件 -->
        <nav aria-label="Page navigation" class="d-flex justify-content-end pagination-container">
            <ul class="pagination pagination-sm">
                {% for page in page_numbers %}
                    {% if page == '...' %}
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% else %}
                        <li class="page-item {% if page == current_page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('main.bonus_search', page=page) }}">{{ page }}</a>
                        </li>
                    {% endif %}
                {% endfor %}
            </ul>
        </nav>

    </div>



    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('copyButton').addEventListener('click', function () {
                // 定义baseResultsData
                var baseResultsData = [
                    {% for row in baseresults %}
                        {
                            公司id: {{ row.company_id }},
                            订单号: {{ row.id }},
                            来源: "{{ row.channel|default('') }}",
                            平台订单号: "{{ row.channel_order_id | default('', true) }}",
                            预订人: "{{ row.info_realname | default('', true) }}",
                            联系: "{{ row.info_phone | default('', true) }}",
                            房型: "{{ row.unit_name | default('', true) }}",
                            房号: "{{ row.room_no | default('', true) }}",
                            入住信息: "{{ row.Check_in | default('', true) }}",
                        }{% if not loop.last %},{% endif %}
                    {% endfor %}
                ];

                var csxResultsData = [
                    {% for csxrow in csxresults %}
                        {
                            微信交易号: "{{ csxrow.ord_no }}",
                            商户交易号: "{{ csxrow.out_no }}",
                            {% if csxrow.out_no_head == 'd_X' %}
                                押金: {{ csxrow.trade_amount }},
                            {% else %}
                                房费: {{ csxrow.trade_amount }},
                            {% endif %}
                            退款: "{{ csxrow.refund_amount }}",


                        }{% if not loop.last %},{% endif %}
                    {% endfor %}
                ];

                // 将数据转换为一个没有引号的字符串，但这不是一个有效的JSON字符串
                var formattedString = '';
                baseResultsData.forEach(function (item) {
                    formattedString += Object.keys(item).map(function (key) {
                        return key + ': ' + item[key];
                    }).join('\n') + '\n';
                });
                csxResultsData.forEach(function (item) {
                    formattedString += Object.keys(item).map(function (key) {
                        return key + ': ' + item[key];
                    }).join('\n') + '\n\n';
                });
                var fullString = formattedString + '微信支付投诉:\n这个是来自微信支付平台的投诉，麻烦问下这个客人具体情况是？，我们需要处理下投诉，以免影响支付的使用\n\n';
                // 使用navigator.clipboard.writeText方法复制到剪贴板
                navigator.clipboard.writeText(fullString).then(function () {
                    showCopySuccessToast();
                })
                    .catch(function (err) {
                        console.error('复制到剪贴板失败:', err);
                    });
            });

            function showCopySuccessToast() {
                var toastDiv = document.createElement('div');
                toastDiv.textContent = '数据已复制到剪贴板';
                toastDiv.style.position = 'fixed';
                toastDiv.style.top = '10%';
                toastDiv.style.left = '50%';
                toastDiv.style.transform = 'translateX(-50%)';
                toastDiv.style.backgroundColor = '#f8d7da';
                toastDiv.style.color = '#721c24';
                toastDiv.style.padding = '10px';
                toastDiv.style.borderRadius = '5px';
                toastDiv.style.zIndex = '1000';
                toastDiv.style.minWidth = '250px';
                toastDiv.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
                document.body.appendChild(toastDiv);

                // 移除提示信息
                setTimeout(function () {
                    document.body.removeChild(toastDiv);
                }, 2000);
            }
        });
    </script>
    {#    <style>#}
    {#    .input-group-text, .btn {#}
    {#    width: 200px;#}
    {#}#}
    {#    </style>#}
{% endblock %}


